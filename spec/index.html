
        <!DOCTYPE html>
        <html lang="en">
          <head>
            <meta charset="utf-8">
            <meta http-equiv="X-UA-Compatible" content="IE=edge">
            <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">

            <title>DIF Sidetree Protocol</title>
            <link href="../spec/spec-up/css/custom-elements.css" rel="stylesheet">
            <link href="../spec/spec-up/css/prism.css" rel="stylesheet">
            <link href="../spec/spec-up/css/chart.css" rel="stylesheet">
            <link href="../spec/spec-up/css/font-awesome.css" rel="stylesheet">
            <link href="../spec/spec-up/css/index.css" rel="stylesheet">
            <script src="../spec/spec-up/js/custom-elements.js"></script>
          </head>
          <body features="source logo">
            
            <svg id="svg" version="1.1" xmlns="http://www.w3.org/2000/svg">
  <symbol id="github" viewBox="0 0 20 20">
    <path d="M10 0.247c-5.522 0-10 4.477-10 10 0 4.418 2.865 8.167 6.839 9.489 0.5 0.093 0.683-0.217 0.683-0.481 0-0.238-0.009-1.026-0.014-1.862-2.782 0.605-3.369-1.18-3.369-1.18-0.455-1.156-1.11-1.463-1.11-1.463-0.907-0.621 0.069-0.608 0.069-0.608 1.004 0.071 1.533 1.031 1.533 1.031 0.892 1.529 2.339 1.087 2.91 0.831 0.090-0.646 0.349-1.087 0.635-1.337-2.221-0.253-4.556-1.11-4.556-4.942 0-1.092 0.391-1.984 1.030-2.684-0.104-0.252-0.446-1.269 0.097-2.646 0 0 0.84-0.269 2.751 1.025 0.798-0.222 1.653-0.333 2.503-0.337 0.85 0.004 1.706 0.115 2.505 0.337 1.909-1.294 2.747-1.025 2.747-1.025 0.544 1.378 0.202 2.395 0.098 2.646 0.641 0.7 1.029 1.592 1.029 2.684 0 3.841-2.339 4.687-4.566 4.934 0.359 0.31 0.678 0.919 0.678 1.852 0 1.338-0.012 2.415-0.012 2.744 0 0.266 0.18 0.578 0.687 0.48 3.971-1.324 6.833-5.071 6.833-9.488 0-5.523-4.477-10-10-10z"></path>
  </symbol>
  <symbol id="nested_list" viewBox="0 0 37 32">
    <path d="M0 2.286c0-1.262 1.023-2.286 2.286-2.286s2.286 1.023 2.286 2.286c0 1.262-1.023 2.286-2.286 2.286s-2.286-1.023-2.286-2.286zM9.143 0h27.429v4.571h-27.429zM9.143 11.429c0-1.262 1.023-2.286 2.286-2.286s2.286 1.023 2.286 2.286c0 1.262-1.023 2.286-2.286 2.286s-2.286-1.023-2.286-2.286zM18.286 9.143h18.286v4.571h-18.286zM9.143 29.714c0-1.262 1.023-2.286 2.286-2.286s2.286 1.023 2.286 2.286c0 1.262-1.023 2.286-2.286 2.286s-2.286-1.023-2.286-2.286zM18.286 27.429h18.286v4.571h-18.286zM18.286 20.571c0-1.262 1.023-2.286 2.286-2.286s2.286 1.023 2.286 2.286c0 1.262-1.023 2.286-2.286 2.286s-2.286-1.023-2.286-2.286zM27.429 18.286h9.143v4.571h-9.143z"></path>
  </symbol>
</svg>

            <main>

              <header id="header" class="panel-header">
                <span id="toc_toggle" panel-toggle="toc">
                  <svg icon><use xlink:href="#nested_list"></use></svg>
                </span>
                <a id="logo" href="https://identity.foundation">
                  <img src="https://rawcdn.githack.com/decentralized-identity/decentralized-identity.github.io/a3ca39717e440302d1fd99a796e7f00e1c42eb2d/images/logo-flat.svg" />
                </a>
                <span issue-count animate panel-toggle="repo_issues">
                  <svg icon><use xlink:href="#github"></use></svg>
                </span>
              </header>

              <article id="content">
                <h1 id="sidetree"><a class="toc-anchor" href="#sidetree">§</a> Sidetree</h1>
<p><strong>Specification Status:</strong> Editor’s Draft</p>
<p><strong>Latest published version:</strong>
<a href="https://identity.foundation/sidetree/spec">identity.foundation/sidetree/spec</a></p>
<dl>
<dt><strong>Editors:</strong></dt>
<dd><a href="https://www.linkedin.com/in/dbuchner/">Daniel Buchner</a> (Microsoft)</dd>
<dd><a href="https://www.linkedin.com/in/or13b/">Orie Steele</a> (Transmute)</dd>
<dt><strong>Contributors:</strong></dt>
<dd><a href="https://www.linkedin.com/in/henry-tsai-6b884014/">Henry Tsai</a> (Microsoft)</dd>
<dd><a href="https://www.linkedin.com/in/troyronda/">Troy Ronda</a> (SecureKey)</dd>
<dd><a href="https://www.linkedin.com/in/mudassir-ali-4981654/">Mudassir Ali</a> (Microsoft)</dd>
<dd><a href="https://www.linkedin.com/in/guillaume-dardelet/">Guillaume Dardelet</a> (Transmute)</dd>
<dd><a href="https://www.linkedin.com/in/isaac-chen-921079127/">Isaac Chen</a> (Microsoft)</dd>
<dd><a href="https://www.linkedin.com/in/chrislun/">Christian Lundkvist</a> (Consensys)</dd>
<dd><a href="https://www.linkedin.com/in/kyledenhartog/">Kyle Den Hartog</a> (Mattr)</dd>
<dt><strong>Participate:</strong></dt>
<dd><a href="https://github.com/decentralized-identity/sidetree">GitHub repo</a></dd>
<dd><a href="https://github.com/decentralized-identity/sidetree/issues">File a bug</a></dd>
<dd><a href="https://github.com/decentralized-identity/sidetree/commits/master">Commit history</a></dd>
</dl>
<hr>
<h2 id="abstract"><a class="toc-anchor" href="#abstract">§</a> Abstract</h2>
<p>Sidetree is a protocol for creating scalable ‘Layer 2’ Decentralized Identifier/DPKI networks that can run atop any decentralized ledger system (e.g. Bitcoin) and be as open, public, and permissionless as the underlying ledger they utilize. Identifiers and PKI metadata in the protocol are expressed via the emerging <a href="https://w3c.github.io/did-core/">W3C Decentralized Identifiers</a> standard. Implementations of the protocol can be codified as their own distinct <em>DID Methods</em> in the <a href="https://w3c-ccg.github.io/did-method-registry/">W3C DID Method Registry</a>. <em>DID Methods</em> are deterministic mechanisms for creating unique, user-owned identifiers (<code>did:method:123</code>) and managing their associated PKI metadata (represented in the <em>DID Document</em> data format), all without the need for centralized authorities or trusted third parties. DID Method indicators are present in DID identifier strings via unique prefixes that distinguish one from another (<code>did:foo:123</code>, <code>did:bar:123</code>, etc.); Sidetree is not a DID Method in itself, but a protocol that can be implemented atop decentralized ledgers to create DID Method implementations (e.g. <code>did:ion</code>, <code>did:elem</code>).</p>
<h2 id="introduction"><a class="toc-anchor" href="#introduction">§</a> Introduction</h2>
<p><em>This section is non-normative</em></p>
<p>Decentralized ledgers (e.g. Bitcoin) introduced the first-ever solution to the linear chronological oracle problem, which unlocked the ability to create robust decentralized identifier networks. However, current approaches that utilize these ledger systems to create decentralized identifier networks suffer from severely limited transactional volumes and other performance issues. Sidetree is a ‘Layer 2’ protocol that runs atop decentralized ledger systems to enable scalable <a href="https://w3c.github.io/did-core/">W3C <em>Decentralized Identifier</em></a> (DID) implementations that can be fully open, public, and permissionless. Sidetree is able to do all this without requiring trusted intermediaries, centralized authorities, special protocol tokens, or secondary consensus mechanisms, while preserving the core attributes of decentralization and immutability of the underlying ledger systems it is implemented on.</p>
<p>Architecturally, Sidetree-based DID Method implementations are overlay networks composed of independent peer nodes (<em>Sidetree nodes</em>) that observe an underlying decentralized ledger (as illustrated above), replicate DID PKI state data linked from the ledger, and execute against that data a set of deterministic protocol rules to produce an eventually strongly consistent view of all Decentralized Identifiers in the network. The Sidetree protocol defines a core set of DID PKI state change <em>operations</em>, structured as delta-based Conflict-Free Replicated Data Types (i.e. <a href="#create">Create</a>, <a href="#update">Update</a>, <a href="#recover">Recover</a>, or <a href="#deactivate">Deactivate</a>), that mutate a Decentralized Identifier’s <em>DID Document</em> state. <em>Sidetree nodes</em> that participate in writing operations into the overlay network do so by anchoring <em>Content-Addressable Storage (CAS)</em> (e.g. IPFS) references to aggregated bundles of <em>operations</em> in an underlying ledger. The ledger acts as a linear chronological sequencing oracle, which the protocol leverages to order DID PKI operations in an immutable history all observing nodes can replay and validate. It is this ability to replay the precise sequence of DID PKI state change events, and process those events using a common set of deterministic rules, that allows <em>Sidetree nodes</em> to achieve a consistent view of DIDs and their <em>DID Document</em> states, without requiring any additional consensus mechanism.</p>
<h2 id="terminology"><a class="toc-anchor" href="#terminology">§</a> Terminology</h2>
<table>
<thead>
<tr>
<th>Term</th>
<th>Description</th>
</tr>
</thead>
<tbody>
<tr>
<td><a href="#anchor-file">Anchor File</a></td>
<td>JSON Document containing proving and index data for Create, Recovery, and Deactivate operations, and a CAS URI for the associated Map File. This file is anchored to the target ledger.</td>
</tr>
<tr>
<td>Map File</td>
<td>JSON Document containing Update operation proving and index data, as well as CAS URI for Chunk File chunks.</td>
</tr>
<tr>
<td>Chunk File</td>
<td>JSON Document containing all verbose operation data for the corresponding set of DIDs specified in the related Map File.</td>
</tr>
<tr>
<td>CAS</td>
<td>Content-addressable storage protocol/network (e.g. IPFS)</td>
</tr>
<tr>
<td>DID Document</td>
<td>JSON Document containing public key references, service endpoints, and other PKI metadata that corresponds to a given DID (as defined in the <a href="https://w3c.github.io/did-core/">W3C DID Specification</a>).</td>
</tr>
<tr>
<td id="did-suffix">DID Suffix</td>
<td>The unique identifier string within a DID URI. e.g. The unique suffix of <code>did:sidetree:123</code> would be <code>123</code>.</td>
</tr>
<tr>
<td>DID Suffix Data</td>
<td>Data required to deterministically generate a DID.</td>
</tr>
<tr>
<td id="multihash">Multihash </td>
<td>Protocol for differentiating outputs from common cryptographic hash functions, addressing size + encoding considerations: <a href="https://multiformats.io/multihash/">https://multiformats.io/multihash/</a></td>
</tr>
<tr>
<td>DID Operation</td>
<td>Set of delta-based modifications that change the state of a DID Document when applied.</td>
</tr>
<tr>
<td>Operation Request</td>
<td>JWS formatted request sent to a <em>Sidetree Node</em> to include a <em>DID Operation</em> in a batch of operations.</td>
</tr>
<tr>
<td>Recovery Key</td>
<td>Public/private key pair used to perform a Recovery or Deactivate operation. Must be encoded as JWK or Hex.</td>
</tr>
<tr>
<td>Sidetree Node</td>
<td>Executable code that implements all the required components, functionality, and rules specified in the Sidetree protocol specification.</td>
</tr>
<tr>
<td>Transaction</td>
<td>Ledger transaction that anchors a set of Sidetree operations, via a CAS URI for an associated Anchor File.</td>
</tr>
<tr>
<td id="ledger-time">Ledger Time</td>
<td>The deterministic logical clock variable manifested in the underlying ledger system that can be used as a deterministic chronological reference (e.g. Bitcoin block numbers).</td>
</tr>
<tr>
<td id="transaction-number">Transaction Number </td>
<td>A monotonically increasing number deterministically ordered and assigned to every transaction relative to its position in <a href="#ledger-time">Ledger Time</a>.</td>
</tr>
<tr>
<td id="light-node">Light Node </td>
<td>A node that downloads and processes only <a href="#anchor-file">Anchor Files</a> and <a href="#map-file">Map Files</a> on a proactive basis, waiting until resolution time to download and process the <a href="#chunk-files">Chunk File</a> related to a given DID. This type of configuration enables a node to operate trustlessly while consuming approximately one order of magnitude less storage.</td>
</tr>
</tbody>
</table>
<h2 id="protocol-versioning"><a class="toc-anchor" href="#protocol-versioning">§</a> Protocol Versioning</h2>
<p>The rules and parameters of the Sidetree protocol MAY change in the future, resulting in new versions of the specification. The Sidetree specification and reference implementation follow <a href="https://semver.org/">SemVer 2.0</a>.</p>
<p>Versions of the specification can be found on the Decentralized Identity Foundation’s website at the following version-based paths:</p>
<pre class="language-html"><code class="language-html">https://identity.foundation/sidetree/docs/v<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>major</span><span class="token punctuation">></span></span>.<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>minor</span><span class="token punctuation">></span></span>.<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>patch</span><span class="token punctuation">></span></span>/
</code></pre>
<p>Versions of the Sidetree reference implementation are provided as npm modules and <a href="https://github.com/decentralized-identity/sidetree/releases">GitHub releases</a>:</p>
<pre class="language-json"><code class="language-json"><span class="token punctuation">{</span>
  <span class="token property">"name"</span><span class="token operator">:</span> <span class="token string">"@decentralized-identity/sidetree"</span><span class="token punctuation">,</span>
  <span class="token property">"version"</span><span class="token operator">:</span> <span class="token string">"&lt;major>.&lt;minor>.&lt;patch>"</span><span class="token punctuation">,</span>
  ...
</code></pre>
<h3 id="version-segment-definitions"><a class="toc-anchor" href="#version-segment-definitions">§</a> Version Segment Definitions</h3>
<ul>
<li><strong>Major:</strong> Major protocol evolution, with breaking protocol advancements so large they warrant incrementing the major version.</li>
<li><strong>Minor:</strong> Critical updates, protocol forking changes, or security patches that require all nodes to upgrade.</li>
<li><strong>Patch:</strong> Non-critical changes that do not require nodes to upgrade.</li>
</ul>
<h3 id="new-version-activation"><a class="toc-anchor" href="#new-version-activation">§</a> New Version Activation</h3>
<p>New versions of the protocol, or modifications to parameter values by implementers, <strong><strong>MUST</strong></strong> be activated at a specified <a href="#ledger-time"><em>Ledger Time</em></a> so all nodes can remain in sync by enforcing the same ruleset and parameters beginning at the same logical starting point. All transactions that occur after the specified <a href="#ledger-time"><em>Ledger Time</em></a> will adhere to the associated version’s rules and parameters until a newer version of the protocol is defined and implemented at a future <a href="#ledger-time"><em>Ledger Time</em></a>.</p>
<h2 id="default-parameters"><a class="toc-anchor" href="#default-parameters">§</a> Default Parameters</h2>
<p>Each version of the protocol will define a set of protocol rules and parameters with default suggested values. The following are the parameters used by this version of the Sidetree protocol - implementers MAY choose different options than the defaults listed below:</p>
<table>
<thead>
<tr>
<th>Protocol Parameter</th>
<th>Description</th>
<th style="text-align:left">Suggested Defaults</th>
</tr>
</thead>
<tbody>
<tr>
<td id="hash-algorithm"><code>HASH_ALGORITHM</code></td>
<td>Algorithm for generating hashes of protocol-related values.</td>
<td style="text-align:left">SHA256</td>
</tr>
<tr>
<td id="hash-protocol"><code>HASH_PROTOCOL</code></td>
<td>Protocol for generating hash representations in Sidetree implementations, using the <a href="#hash-algorithm"><code>HASH_ALGORITHM</code></a></td>
<td style="text-align:left"><a href="#multihash">Multihash</a></td>
</tr>
<tr>
<td id="data-encoding-scheme"><code>DATA_ENCODING_SCHEME</code></td>
<td>Encoding selected for various data (JSON, hashes, etc.) used within an implementation, the output of which <strong><strong>MUST</strong></strong> be in ASCII format.</td>
<td style="text-align:left">Base64URL</td>
</tr>
<tr>
<td id="key-algorithm"><code>KEY_ALGORITHM</code></td>
<td>Asymmetric public key algorithm for signing DID operations. Must be a valid JWK <code>crv</code>.</td>
<td style="text-align:left">secp256k1</td>
</tr>
<tr>
<td id="sig-algorithm"><code>SIGNATURE_ALGORITHM</code></td>
<td>Asymmetric public key signature algorithm. Must be a valid JWS <code>alg</code>.</td>
<td style="text-align:left">ES256K</td>
</tr>
<tr>
<td id="cas-protocol"><code>CAS_PROTOCOL</code></td>
<td>The CAS network protocol used within an implementation.</td>
<td style="text-align:left">IPFS</td>
</tr>
<tr>
<td id="cid-algorithm"><code>CID_ALGORITHM</code></td>
<td>Algorithm for generating CAS Identifiers.</td>
<td style="text-align:left">IPFS CID</td>
</tr>
<tr>
<td id="compression-algorithm"><code>COMPRESSION_ALGORITHM</code></td>
<td>File compression algorithm</td>
<td style="text-align:left">ZIP</td>
</tr>
<tr>
<td id="commitment-value"><code>COMMITMENT_VALUE</code></td>
<td>Cryptographically random value to be revealed in the next operation.</td>
<td style="text-align:left">32 bytes</td>
</tr>
<tr>
<td id="genesis-time"><code>GENESIS_TIME</code></td>
<td>The point in the target ledger’s transaction history at which Sidetree implementation is first activated (e.g. block number in a blockchain).</td>
<td style="text-align:left">630000</td>
</tr>
<tr>
<td id="max-anchor-file-size"><code>MAX_ANCHOR_FILE_SIZE</code></td>
<td>Maximum compressed Anchor File size.</td>
<td style="text-align:left">1 MB</td>
</tr>
<tr>
<td id="max-map-file-size"><code>MAX_MAP_FILE_SIZE</code></td>
<td>Maximum compressed map file size.</td>
<td style="text-align:left">1 MB</td>
</tr>
<tr>
<td id="max-chunk-file-size"><code>MAX_CHUNK_FILE_SIZE</code> </td>
<td>Maximum compressed batch file size.</td>
<td style="text-align:left">10 MB</td>
</tr>
<tr>
<td><code>MAX_ENCODED_HASH_LENGTH</code></td>
<td>Maximum accepted string length of an encoded hash.</td>
<td style="text-align:left">100 bytes</td>
</tr>
<tr>
<td><code>MAX_OPERATION_SIZE</code></td>
<td>Maximum uncompressed operation size.</td>
<td style="text-align:left">1 kb</td>
</tr>
<tr>
<td><code>MAX_OPERATION_COUNT</code></td>
<td>Maximum number of operations per batch.</td>
<td style="text-align:left">10,000</td>
</tr>
</tbody>
</table>
<h2 id="common-functions"><a class="toc-anchor" href="#common-functions">§</a> Common Functions</h2>
<p>The following is a list of functional procedures that are commonly used across the protocol. These functions are defined once here and referenced throughout the specification, wherever an implementer must invoke them to comply with normative processes.</p>
<h3 id="hashing-process"><a class="toc-anchor" href="#hashing-process">§</a> Hashing Process</h3>
<p>All data hashed within the bounds of the protocol follow the same procedural steps, and yield a consistently encoded output. Given a data value, the following steps are used to generated a hashed output:</p>
<ol>
<li>Generate a hash of the data value using the <a href="#hash-protocol"><code>HASH_PROTOCOL</code></a> with the <a href="#hash-algorithm"><code>HASH_ALGORITHM</code></a>.</li>
<li>Encode the resulting output using the <a href="#data-encoding-scheme"><code>DATA_ENCODING_SCHEME</code></a>.</li>
<li>Return the encoded hashing output.</li>
</ol>
<p>Pseudo-code example using current protocol defaults:</p>
<pre class="language-js"><code class="language-js"><span class="token keyword">let</span> HashingOutput <span class="token operator">=</span> <span class="token function">Base64URL</span><span class="token punctuation">(</span> <span class="token function">Multihash</span><span class="token punctuation">(</span><span class="token constant">DATA</span><span class="token punctuation">,</span> <span class="token string">'sha2-256'</span><span class="token punctuation">)</span> <span class="token punctuation">)</span><span class="token punctuation">;</span>
</code></pre>
<h2 id="network-topology"><a class="toc-anchor" href="#network-topology">§</a> Network Topology</h2>
<p>The figure below illustrates the three primary components of a Sidetree-based DID overlay network:</p>
<ol>
<li>The underlying ledger system that serves as the global anchoring and linear sequencing system for DID operations.</li>
<li>The Sidetree nodes themselves, which interact with the ledger system to anchor operations, fetch and replicate data from the CAS network, and process operations in accordance with the protocol deterministic ruleset.</li>
<li>An integrated Content-Addressable Storage (CAS) network layer Sidetree nodes use to distribute and replicate DID operation files.</li>
</ol>
<img src="../docs/diagrams/sidetree-system.svg" style="display: block; margin: 0 auto; padding: 1em 0; width: 100%; max-width: 620px;" />
<h2 id="file-structures"><a class="toc-anchor" href="#file-structures">§</a> File Structures</h2>
<p>The protocol defines the following three file structures, which house DID operation data and are designed to support key functionality to enable light node configurations, minimize permanently retained data, and ensure performant resolution of DIDs.</p>
<img src="../docs/diagrams/file-topology.svg" style="display: block; margin: 0 auto; padding: 2em 0; width: 100%; max-width: 620px;" />
<h3 id="anchor-file"><a class="toc-anchor" href="#anchor-file">§</a> Anchor File</h3>
<p>Anchor Files contain <a href="#create">Create</a>, <a href="#recover">Recover</a>, and <a href="#deactivate">Deactivate</a> operation values, as well as a CAS URI for the related Sidetree Map file (detailed below). As the name suggests, Anchor Files are anchored to the target ledger system via embedding a CAS URI in the ledger’s transactional history.</p>
<div id="example-31" class="notice example"><a class="notice-link" href="#example-31">EXAMPLE</a><pre class="language-json"><code class="language-json"><span class="token punctuation">{</span>
  <span class="token property">"map_file_uri"</span><span class="token operator">:</span> CAS_URI<span class="token punctuation">,</span>
  <span class="token property">"operations"</span><span class="token operator">:</span> <span class="token punctuation">{</span>
    <span class="token property">"create"</span><span class="token operator">:</span> <span class="token punctuation">[</span>
      <span class="token punctuation">{</span>
        <span class="token property">"suffix_data"</span><span class="token operator">:</span> <span class="token punctuation">{</span> <span class="token comment">// Base64URL encoded</span>
          <span class="token property">"delta_hash"</span><span class="token operator">:</span> DELTA_HASH<span class="token punctuation">,</span>
          <span class="token property">"recovery_key"</span><span class="token operator">:</span> JWK_OBJECT<span class="token punctuation">,</span>
          <span class="token property">"recovery_commitment"</span><span class="token operator">:</span> COMMITMENT_HASH
        <span class="token punctuation">}</span>
      <span class="token punctuation">}</span><span class="token punctuation">,</span>
      <span class="token punctuation">{</span>...<span class="token punctuation">}</span>
    <span class="token punctuation">]</span><span class="token punctuation">,</span>
    <span class="token property">"recover"</span><span class="token operator">:</span> <span class="token punctuation">[</span>
      <span class="token punctuation">{</span>
        <span class="token property">"did_suffix"</span><span class="token operator">:</span> SUFFIX_STRING<span class="token punctuation">,</span>
        <span class="token property">"recovery_reveal_value"</span><span class="token operator">:</span> REVEAL_VALUE<span class="token punctuation">,</span>
        <span class="token property">"signed_data"</span><span class="token operator">:</span> <span class="token punctuation">{</span> <span class="token comment">// Base64URL encoded, compact JWS</span>
            <span class="token property">"protected"</span><span class="token operator">:</span> <span class="token punctuation">{</span>...<span class="token punctuation">}</span><span class="token punctuation">,</span>
            <span class="token property">"payload"</span><span class="token operator">:</span> <span class="token punctuation">{</span>
                <span class="token property">"recovery_commitment"</span><span class="token operator">:</span> COMMITMENT_HASH<span class="token punctuation">,</span>
                <span class="token property">"delta_hash"</span><span class="token operator">:</span> DELTA_HASH<span class="token punctuation">,</span>
                <span class="token property">"recovery_key"</span><span class="token operator">:</span> JWK_OBJECT
            <span class="token punctuation">}</span><span class="token punctuation">,</span>
            <span class="token property">"signature"</span><span class="token operator">:</span> SIGNATURE_STRING
        <span class="token punctuation">}</span>
      <span class="token punctuation">}</span><span class="token punctuation">,</span>
      <span class="token punctuation">{</span>...<span class="token punctuation">}</span>
    <span class="token punctuation">]</span><span class="token punctuation">,</span>
    <span class="token property">"deactivate"</span><span class="token operator">:</span> <span class="token punctuation">[</span>
      <span class="token punctuation">{</span>
        <span class="token property">"did_suffix"</span><span class="token operator">:</span> SUFFIX_STRING<span class="token punctuation">,</span>
        <span class="token property">"recovery_reveal_value"</span><span class="token operator">:</span> REVEAL_VALUE<span class="token punctuation">,</span>
        <span class="token property">"signed_data"</span><span class="token operator">:</span> <span class="token punctuation">{</span> <span class="token comment">// Base64URL encoded, compact JWS</span>
            <span class="token property">"protected"</span><span class="token operator">:</span> <span class="token punctuation">{</span>...<span class="token punctuation">}</span><span class="token punctuation">,</span>
            <span class="token property">"payload"</span><span class="token operator">:</span> <span class="token punctuation">{</span>
              <span class="token property">"did_suffix"</span><span class="token operator">:</span> SUFFIX_STRING<span class="token punctuation">,</span>
              <span class="token property">"recovery_reveal_value"</span><span class="token operator">:</span> REVEAL_VALUE
            <span class="token punctuation">}</span><span class="token punctuation">,</span>
            <span class="token property">"signature"</span><span class="token operator">:</span> SIGNATURE_STRING
        <span class="token punctuation">}</span>
      <span class="token punctuation">}</span><span class="token punctuation">,</span>
      <span class="token punctuation">{</span>...<span class="token punctuation">}</span>
    <span class="token punctuation">]</span>
  <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre>
</div>
<p>A valid <a href="#anchor-file">Anchor File</a> is a JSON document that <strong><strong>MUST NOT</strong></strong> exceed the <a href="#max-anchor-file-size"><code>MAX_ANCHOR_FILE_SIZE</code></a>, and composed as follows:</p>
<ol>
<li>The <a href="#anchor-file">Anchor File</a> <strong><strong>MUST</strong></strong> contain a <a href="#map-file-property" id="map-file-property"><code>map_file_uri</code></a> property, and its value <strong><strong>MUST</strong></strong> be a <em>CAS URI</em> for the related Map File.</li>
<li>If the set of operations to be anchored contain any <a href="#create">Create</a>, <a href="#recovery">Recover</a>, or <a href="#deactivate">Deactivate</a> operations, the <a href="#anchor-file">Anchor File</a> <strong><strong>MUST</strong></strong> contain an <code>operations</code> property, and its value <strong><strong>MUST</strong></strong> be an object composed as follows:
<ul>
<li>If there are any <a href="#create">Create</a> operations to be included in the Anchor File:
<ol>
<li>The <code>operations</code> object <strong><strong>MUST</strong></strong> include a <code>create</code> property, and its value <strong><strong>MUST</strong></strong> be an array.</li>
<li>For each <a href="#create">Create</a> operation to be included in the <code>create</code> array, herein referred to as <a href="#anchor-file-create-entry" id="anchor-file-create-entry"><em>Anchor File Create Entries</em></a>, use the following process to compose and include a JSON object for each entry:
<ul>
<li>Each entry object must contain a <code>suffix_data</code> property, and its value <strong><strong>MUST</strong></strong> be a <a href="#create-suffix-data-object"><em>Create Operation Suffix Data Object</em></a>.</li>
</ul>
</li>
<li>The <a href="#anchor-file">Anchor File</a> <strong><strong>MUST NOT</strong></strong> include multiple <a href="#create">Create</a> operations that produce the same <a href="#did-suffix">DID Suffix</a>.</li>
<li>In order to simplify the language, herein we will refer to the <a href="#did-suffix">DID Suffix</a> produced by a <a href="#create">Create</a> operation directly as its <a href="#did-suffix">DID Suffix</a>.</li>
</ol>
</li>
<li>If there are any <a href="#recover">Recovery</a> operations to be included in the Anchor File:
<ol>
<li>The <code>operations</code> object <strong><strong>MUST</strong></strong> include a <code>recover</code> property, and its value <strong><strong>MUST</strong></strong> be an array.</li>
<li>For each <a href="#recover">Recovery</a> operation to be included in the <code>recover</code> array, herein referred to as <a href="#anchor-file-recovery-entry" id="anchor-file-recovery-entry"><em>Anchor File Recovery Entries</em></a>, use the following process to compose and include entries:
<ul>
<li>The object <strong><strong>MUST</strong></strong> contain a <code>did_suffix</code> property, and its value <strong><strong>MUST</strong></strong> be the <a href="#did-suffix">DID Suffix</a> of the DID the operation pertains to. An <a href="#anchor-file">Anchor File</a> <strong><strong>MUST NOT</strong></strong> contain more than one operation of any type with the same <a href="#did-suffix">DID Suffix</a>.</li>
<li>The object <strong><strong>MUST</strong></strong> contain a <code>recovery_reveal_value</code> property, and its value <strong><strong>MUST</strong></strong> be the last recovery <a href="#commitment-value"><code>COMMITMENT_VALUE</code></a>.</li>
<li>The object <strong><strong>MUST</strong></strong> contain a <code>signed_data</code> property, and its value <strong><strong>MUST</strong></strong> be a <a href="#recovery-signed-data-object"><em>Recovery Operation Signed Data Object</em></a>.</li>
</ul>
</li>
</ol>
</li>
<li>If there are any <a href="#deactivate">Deactivate</a> operations to be included in the Anchor File:
<ol>
<li>The <code>operations</code> object <strong><strong>MUST</strong></strong> include a <code>deactivate</code> property, and its value <strong><strong>MUST</strong></strong> be an array.</li>
<li>For each <a href="#deactivate">Deactivate</a> operation to be included in the <code>deactivate</code> array, use the following process to compose and include entries:
<ul>
<li>The object <strong><strong>MUST</strong></strong> contain a <code>did_suffix</code> property, and its value <strong><strong>MUST</strong></strong> be the <a href="#did-suffix">DID Suffix</a> of the DID the operation pertains to. An <a href="#anchor-file">Anchor File</a> <strong><strong>MUST NOT</strong></strong> contain more than one operation of any type with the same <a href="#did-suffix">DID Suffix</a>.</li>
<li>The object <strong><strong>MUST</strong></strong> contain a <code>recovery_reveal_value</code> property, and its value <strong><strong>MUST</strong></strong> be the last recovery <a href="#commitment-value"><code>COMMITMENT_VALUE</code></a>.</li>
<li>The object <strong><strong>MUST</strong></strong> contain a <code>signed_data</code> property, and its value <strong><strong>MUST</strong></strong> be a <a href="#deactivate-signed-data-object"><em>Deactivate Operation Signed Data Object</em></a>.</li>
</ul>
</li>
</ol>
</li>
</ul>
</li>
</ol>
<h3 id="map-file"><a class="toc-anchor" href="#map-file">§</a> Map File</h3>
<p>The Map file in the Sidetree protocol contains Update operation proving data, as well as the CAS-linked Chunk file chunks.</p>
<div id="example-32" class="notice example"><a class="notice-link" href="#example-32">EXAMPLE</a><pre class="language-json"><code class="language-json"><span class="token punctuation">{</span>
  <span class="token property">"chunks"</span><span class="token operator">:</span> <span class="token punctuation">[</span>
    <span class="token punctuation">{</span> <span class="token property">"chunk_file_uri"</span><span class="token operator">:</span> CHUNK_HASH <span class="token punctuation">}</span><span class="token punctuation">,</span>
    <span class="token punctuation">{</span>...<span class="token punctuation">}</span>
  <span class="token punctuation">]</span><span class="token punctuation">,</span>
  <span class="token property">"operations"</span><span class="token operator">:</span> <span class="token punctuation">{</span>
    <span class="token property">"update"</span><span class="token operator">:</span> <span class="token punctuation">[</span>
      <span class="token punctuation">{</span>
        <span class="token property">"did_suffix"</span><span class="token operator">:</span> DID_SUFFIX<span class="token punctuation">,</span>
        <span class="token property">"update_reveal_value"</span><span class="token operator">:</span> REVEAL_VALUE<span class="token punctuation">,</span>
        <span class="token property">"signed_data"</span><span class="token operator">:</span> <span class="token punctuation">{</span> <span class="token comment">// Base64URL encoded, compact JWS</span>
            <span class="token property">"protected"</span><span class="token operator">:</span> <span class="token punctuation">{</span>...<span class="token punctuation">}</span><span class="token punctuation">,</span>
            <span class="token property">"payload"</span><span class="token operator">:</span> <span class="token punctuation">{</span>
              <span class="token property">"delta_hash"</span><span class="token operator">:</span> DELTA_HASH
            <span class="token punctuation">}</span><span class="token punctuation">,</span>
            <span class="token property">"signature"</span><span class="token operator">:</span> SIGNATURE_STRING
        <span class="token punctuation">}</span>   
      <span class="token punctuation">}</span><span class="token punctuation">,</span>
      <span class="token punctuation">{</span>...<span class="token punctuation">}</span>
    <span class="token punctuation">]</span>
  <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre>
</div>
<p>A valid <a href="#map-file">Map File</a> is a JSON document that <strong><strong>MUST NOT</strong></strong> exceed the <a href="#max-map-file-size"><code>MAX_MAP_FILE_SIZE</code></a>, and composed as follows:</p>
<ol>
<li>The <a href="#anchor-file">Anchor File</a> <strong><strong>MUST</strong></strong> contain a <code>chunks</code> property, and its value <strong><strong>MUST</strong></strong> be an array of <em>Chunk Entries</em> for the related delta data for a given chunk of operations in the batch. Future versions of the protocol will specify a process for separating the operations in a batch into multiple <em>Chunk Entries</em>, but for this version of the protocol there <strong><strong>MUST</strong></strong> be only one <em>Chunk Entry</em> present in the array. <em>Chunk Entry</em> objects are composed as follows:
<ol>
<li>The <em>Chunk Entry</em> object <strong><strong>MUST</strong></strong> contain a <code>chunk_file_uri</code> property, and its value <strong><strong>MUST</strong></strong> be a URI representing the corresponding CAS file entry, generated via the <a href="#cid-algorithm"><code>CID_ALGORITHM</code></a>.</li>
</ol>
</li>
<li>If there are any <a href="#update">Update</a> operations to be included in the Map File, the <a href="#map-file">Map File</a> <strong><strong>MUST</strong></strong> include an <code>operations</code> property, and its value <strong><strong>MUST</strong></strong> be an object composed as follows:</li>
<li>The <code>operations</code> object <strong><strong>MUST</strong></strong> include an <code>update</code> property, and its value <strong><strong>MUST</strong></strong> be an array.</li>
<li>For each <a href="#update">Update</a> operation to be included in the <code>update</code> array, herein referred to as <a href="#map-file-update-entry" id="map-file-update-entry">Map File Update Entries</a>, use the following process to compose and include entries:
<ul>
<li>The object <strong><strong>MUST</strong></strong> contain an <code>did_suffix</code> property, and its value <strong><strong>MUST</strong></strong> be the <a href="#did-suffix">DID Suffix</a> of the DID the operation pertains to.</li>
<li>The object <strong><strong>MUST</strong></strong> contain a <code>update_reveal_value</code> property, and its value <strong><strong>MUST</strong></strong> be the last update <a href="#commitment-value"><code>COMMITMENT_VALUE</code></a>.</li>
<li>The object <strong><strong>MUST</strong></strong> contain a <code>signed_data</code> property, and its value <strong><strong>MUST</strong></strong> be an <a href="#update-signed-data-object"><em>Update Operation Signed Data Object</em></a>.</li>
</ul>
</li>
</ol>
<h3 id="chunk-files"><a class="toc-anchor" href="#chunk-files">§</a> Chunk Files</h3>
<p>Chunk Files are JSON Documents, compressed via the <a href="#compression-algorithm">COMPRESSION_ALGORITHM</a> contain Sidetree Operation source data, which are composed of delta-based CRDT entries that modify the state of a Sidetree identifier’s DID Document.</p>
<p>For this version of the protocol, there will only exist a single Chunk File that contains all the state modifying data for all operations in the included set. Future versions of the protocol will separate the total set of included operations into multiple chunks, each with their own Chunk File.</p>
<div id="create-operation-chunk-file-entry-4" class="notice example"><a class="notice-link" href="#create-operation-chunk-file-entry-4">EXAMPLE</a><pre class="language-json"><code class="language-json"><span class="token punctuation">{</span>
  <span class="token property">"deltas"</span><span class="token operator">:</span> <span class="token punctuation">[</span>
       
    <span class="token punctuation">{</span> <span class="token comment">// JSON.stringify()-ed, and Base64URL encoded</span>
      <span class="token property">"patches"</span><span class="token operator">:</span> PATCH_ARRAY<span class="token punctuation">,</span>
      <span class="token property">"update_commitment"</span><span class="token operator">:</span> COMMITMENT_HASH
    <span class="token punctuation">}</span><span class="token punctuation">,</span>
    ...
  <span class="token punctuation">]</span>
<span class="token punctuation">}</span>
</code></pre>
</div>
<p>In this version of the protocol, Chunk Files are constructed as follows:</p>
<ol>
<li>
<p>The Chunk File <strong><strong>MUST</strong></strong> include a <code>deltas</code> property, and its value <strong><strong>MUST</strong></strong> be an array containing <a href="#chunk-file-delta-entry" id="chunk-file-delta-entry"><em>Chunk File Delta Entry</em></a> objects.</p>
</li>
<li>
<p>Each <a href="#chunk-file-delta-entry"><em>Chunk File Delta Entry</em></a> <strong><strong>MUST</strong></strong> be a <code>Base64URL</code> encoded object, assembled as follows:</p>
<ol>
<li>The object <strong><strong>MUST</strong></strong> contain a <code>patches</code> property, and its value <strong><strong>MUST</strong></strong> be an array of <a href="#did-state-patches">DID State Patches</a>.</li>
<li>The payload <strong><strong>MUST</strong></strong> contain an <code>update_commitment</code> property, and its value <strong><strong>MUST</strong></strong> be the next <em>Update Commitment</em> generated during the operation process associated with the type of operation being performed.</li>
</ol>
</li>
<li>
<p>Each <a href="#chunk-file-delta-entry"><em>Chunk File Delta Entry</em></a> <strong><strong>MUST</strong></strong> be appended to the <code>deltas</code> array as follows, in this order:</p>
<ol>
<li>If any Create operations were present in the associated Anchor File, append all <a href="#create-delta-object"><em>Create Operation Delta Objects</em></a> in the same index order as their matching <a href="#anchor-file-create-entry"><em>Anchor File Create Entry</em></a>.</li>
<li>If any Recovery operations were present in the associated Anchor File, append all <a href="#recovery-delta-object"><em>Recovery Operation Delta Objects</em></a> in the same index order as their matching <a href="#anchor-file-recovery-entry"><em>Anchor File Recovery Entry</em></a>.</li>
<li>If any Update operations were present in the associated Map File, append all <a href="#update-delta-object"><em>Update Operation Delta Objects</em></a> in the same index order as their matching <a href="#map-file-update-entry"><em>Map File Update Entry</em></a>.</li>
</ol>
</li>
</ol>
<h2 id="did-uri-composition"><a class="toc-anchor" href="#did-uri-composition">§</a> DID URI Composition</h2>
<p>DID Methods based on the Sidetree protocol all share the same identifier format. The unique identifier string is a hash of the <a href="#create-suffix-data-object"><em>Create Operation Suffix Data Object</em></a>, known as the <a href="#short-form-did" id="short-form-did"><em>Short-Form DID URI</em></a>, which contains values such as the initial recovery public key and patches representing the initial state of the DID Document. The unique identifier string being cryptographically bound to these values enables Sidetree DIDs to be <em>self-certifying</em>, meaning the person or entity who creates a Sidetree-based DID knows their unique identifier the time it is generated, and it is cryptographic secure for instant use (for more on the instant use capabilities of Sidetree DIDs, see <a href="#unpublished-did-resolution">Unpublished DID Resolution</a>).</p>
<p>To generate the unique identifier string of a Sidetree DID, use the <a href="#hashing-process">Hashing Process</a> to generate a hash of the <a href="#create-suffix-data-object"><em>Create Operation Suffix Data Object</em></a>. The following is an example of a resulting colon (<code>:</code>) separated DID URI composed of the URI scheme (<code>did:</code>), Method identifier (<code>sidetree:</code>), and unique identifier string (<code>EiBJz4...</code>):</p>
<pre class="language-css"><code class="language-css"><span class="token property">did</span><span class="token punctuation">:</span><span class="token property">sidetree</span><span class="token punctuation">:</span>EiBJz4qd3Lvof3boqBQgzhMDYXWQ_wZs67jGiAhFCiQFjw
</code></pre>
<h3 id="long-form-did-uris"><a class="toc-anchor" href="#long-form-did-uris">§</a> Long-Form DID URIs</h3>
<p>DID URI strings may include additional values that are used in resolution and other activities. The standard way to pass these values are through <em>DID URL Parameters</em>, as defined by the <a href="https://w3c.github.io/did-core/">W3C Decentralized Identifiers</a> specification.</p>
<p>Many DID Methods require a period of time (which may be indefinite) between the generation of a DID and the DID being anchored/propagated in the underlying ledger system, and other layers for which propagation delays may apply. Sidetree introduces the <code>-METHOD-initial-state</code> <em>DID URL Parameter</em> to enable resolution of unpropagated and unpublished DIDs. To use a Sidetree-based DID immediately after generation, the controller <strong><strong>MUST</strong></strong> include the <code>-METHOD-initial-state</code> <em>DID URL Parameter</em> in the DID URI string, with the value being a string composed of the <a href="#create-suffix-data-object"><em>Create Operation Suffix Data Object</em></a> and the <a href="#create-delta-object"><em>Create Operation Delta Object</em></a>, separated by a period (<code>.</code>), as follows:</p>
<pre class="language-html"><code class="language-html">did:METHOD:<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>did-suffix</span><span class="token punctuation">></span></span>?-METHOD-initial-state=<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>create-suffix-data-object</span><span class="token punctuation">></span></span>.<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>create-delta-object</span><span class="token punctuation">></span></span>
</code></pre>
<p>This <em>DID URL Parameter</em> mechanism of conveying the initial <em>self-certifying</em> state of a DID, known as the <a href="#long-form-did" id="long-form-did"><em>Long-Form DID URI</em></a> supports the following features and usage patterns:</p>
<ul>
<li>Resolving the DID Documents of unpublished DIDs.</li>
<li>Authenticating with unpublished DIDs.</li>
<li>Signing and verifying credentials signed against unpublished DIDs.</li>
<li>After publication and propagation are complete, authenticating with either the <a href="#short-form-did"><em>Short-Form DID URI</em></a> or <a href="#long-form-did"><em>Long-Form DID URI</em></a>.</li>
<li>After publication and propagation are complete, signing and verifying credentials signed against either the <a href="#short-form-did"><em>Short-Form DID URI</em></a> or <a href="#long-form-did"><em>Long-Form DID URI</em></a>.</li>
</ul>
<h2 id="did-operations"><a class="toc-anchor" href="#did-operations">§</a> DID Operations</h2>
<p>Sidetree-based DIDs support a variety of DID operations, all of which require the DID owner to generate specific data values and cryptographic material. The sections below describe how to perform each type of operation, and how those operations are represented in the CAS-replicated files that are anchored to the underlying ledger system.</p>
<p>While virtually all DID owners will engage User Agent applications on their local devices to perform these operations, most will not generate the anchoring transactions on the underlying ledger. Instead, most users will likely send the anchoring-related operation values they generate to external nodes for anchoring. This is relatively safe, because operations require signatures that an external node cannot forge. The only attack available to a rogue node operator is to not anchor the operations a DID owner sends them. However, the DID owner can detect this (via a scan of subsequent blocks) and send their operation to a different node or do it themselves, if they so desire.</p>
<div id="note-13" class="notice note"><a class="notice-link" href="#note-13">NOTE</a><p>This specification does not define an API for sending public DID operation values to third-party Sidetree nodes for external anchoring, as that is an elective activity has no bearing on the technical workings of the protocol, its capabilities, or its security guarantees.</p>
</div>
<h3 id="create"><a class="toc-anchor" href="#create">§</a> Create</h3>
<p>Use the following process to generate a Sidetree-based DID:</p>
<ol>
<li>Generate a key pair via the <a href="#key-algorithm"><code>KEY_ALGORITHM</code></a>. The public key <strong><strong>MUST</strong></strong> be retained for use as the <a href="#initial-recovery-key" id="initial-recovery-key"><em>Initial Recovery Public Key</em></a> portion of the <a href="#did-suffix">DID Suffix</a>, while the the private key <strong><strong>MUST</strong></strong> be securely stored for use in subsequent <a href="#recovery">Recovery</a> operations.</li>
<li>Generate and retain a <a href="#commitment-value"><code>COMMITMENT_VALUE</code></a> for use in the next Recovery operation, herein referred to as <a href="#initial-recovery-commitment" id="initial-recovery-commitment"><em>Initial Recovery Commitment</em></a>.</li>
<li>Generate a <em>Recovery Commitment</em> hash using the <a href="#hashing-process">Hashing Process</a> to generate a hash of the <a href="#commitment-value"><code>COMMITMENT_VALUE</code></a>, and retain the resulting hash value for inclusion in an <a href="#anchor-file">Anchor File</a> (if publication of the DID is desired).</li>
<li>Generate and retain a <a href="#commitment-value"><code>COMMITMENT_VALUE</code></a> for use in the next Update operation, herein referred to as <em>Update Reveal Value</em>.</li>
<li>Generate an <em>Update Commitment</em> hash by using the <a href="#hashing-process">Hashing Process</a> to generate a hash of the <em>Update Reveal Value</em>, and retain the resulting hash value for inclusion in an <a href="#anchor-file">Anchor File</a> (if publication of the DID is desired).</li>
<li>Generate an encoded representation of the following object using the implementation’s <a href="#data-encoding-scheme"><code>DATA_ENCODING_SCHEME</code></a>, herein referred to as the <a href="#create-delta-object" id="create-delta-object"><em>Create Operation Delta Object</em></a>:<pre class="language-json"><code class="language-json"><span class="token punctuation">{</span>
  <span class="token property">"patches"</span><span class="token operator">:</span> <span class="token punctuation">[</span> PATCH_<span class="token number">1</span><span class="token punctuation">,</span> PATCH_<span class="token number">2</span><span class="token punctuation">,</span> ... <span class="token punctuation">]</span><span class="token punctuation">,</span>
  <span class="token property">"update_commitment"</span><span class="token operator">:</span> HASH_OF_UPDATE_COMMITMENT_VALUE
<span class="token punctuation">}</span>
</code></pre>
<ul>
<li>The object <strong><strong>MUST</strong></strong> contain a <code>patches</code> property, and its value <strong><strong>MUST</strong></strong> be an array of <a href="#did-state-patches">DID State Patches</a>.</li>
<li>The object <strong><strong>MUST</strong></strong> contain a <code>update_commitment</code> property, and its value <strong><strong>MUST</strong></strong> be the <em>Update Commitment</em>, as described above.</li>
</ul>
</li>
<li>Generate an encoded representation of the following object using the implementation’s <a href="#data-encoding-scheme"><code>DATA_ENCODING_SCHEME</code></a>, herein referred to as the <a href="#create-suffix-data-object" id="create-suffix-data-object"><em>Create Operation Suffix Data Object</em></a>:<pre class="language-json"><code class="language-json"><span class="token punctuation">{</span>
  <span class="token property">"delta_hash"</span><span class="token operator">:</span> DELTA_HASH<span class="token punctuation">,</span>
  <span class="token property">"recovery_key"</span><span class="token operator">:</span> JWK_OBJECT<span class="token punctuation">,</span>
  <span class="token property">"recovery_commitment"</span><span class="token operator">:</span> COMMITMENT_HASH
<span class="token punctuation">}</span>
</code></pre>
<ul>
<li>The object <strong><strong>MUST</strong></strong> contain a <code>delta_hash</code> property, and its value <strong><strong>MUST</strong></strong> be a hash of the decoded <a href="#create-delta-object"><em>Create Operation Delta Object</em></a> (detailed above), generated via the <a href="#hashing-process">Hashing Process</a>.</li>
<li>The object <strong><strong>MUST</strong></strong> contain the <code>recovery_key</code> property, and its value <strong><strong>MUST</strong></strong> be an <a href="https://tools.ietf.org/html/rfc7517">IETF RFC 7517</a> compliant JWK representation of the <a href="#initial-recovery-key"><em>Initial Recovery Public Key</em></a> (detailed above).</li>
<li>The object <strong><strong>MUST</strong></strong> contain an <code>recovery_commitment</code> property, and its value <strong><strong>MUST</strong></strong> be an <a href="#initial-recovery-commitment"><em>Initial Recovery Commitment</em></a> (detailed above).</li>
</ul>
</li>
</ol>
<div id="note-14" class="notice note"><a class="notice-link" href="#note-14">NOTE</a><p>Implementers MAY choose to canonicalize their <a href="#create-suffix-data-object"><em>Create Operation Suffix Data Objects</em></a> prior applying the <a href="#data-encoding-scheme"><code>DATA_ENCODING_SCHEME</code></a>. This does not affect the outcome or other components in the system that deal with this object.</p>
</div>
<h3 id="update"><a class="toc-anchor" href="#update">§</a> Update</h3>
<p>The following process must be used to update the state a Sidetree-based DID:</p>
<ol>
<li>Retrieve the <em>Update Reveal Value</em> that matches the previously anchored <em>Update Commitment</em>.</li>
<li>Generate an encoded representation of the following object using the implementation’s <a href="#data-encoding-scheme"><code>DATA_ENCODING_SCHEME</code></a>, herein referred to as the <a href="#update-delta-object" id="update-delta-object"><em>Update Operation Delta Object</em></a>, composed as follows:<pre class="language-json"><code class="language-json"><span class="token punctuation">{</span>
  <span class="token property">"patches"</span><span class="token operator">:</span> <span class="token punctuation">[</span> PATCH_<span class="token number">1</span><span class="token punctuation">,</span> PATCH_<span class="token number">2</span><span class="token punctuation">,</span> ... <span class="token punctuation">]</span><span class="token punctuation">,</span>
  <span class="token property">"update_commitment"</span><span class="token operator">:</span> HASH_OF_UPDATE_COMMITMENT_VALUE
<span class="token punctuation">}</span>
</code></pre>
<ul>
<li>The object <strong><strong>MUST</strong></strong> contain a <code>patches</code> property, and its value <strong><strong>MUST</strong></strong> be an array of <a href="#did-state-patches">DID State Patches</a>.</li>
<li>The object <strong><strong>MUST</strong></strong> contain a <code>update_commitment</code> property, and its value <strong><strong>MUST</strong></strong> be a new <em>Update Commitment</em>, the value of which will be revealed for the next Update operation.</li>
</ul>
</li>
<li>Generate an encoded representation of the following object using the implementation’s <a href="#data-encoding-scheme"><code>DATA_ENCODING_SCHEME</code></a>, herein referred to as the <a href="#update-signed-data-object" id="update-signed-data-object"><em>Update Operation Signed Data Object</em></a>. The object <strong><strong>MUST</strong></strong> be a <a href="https://tools.ietf.org/html/rfc7515">IETF RFC 7515</a> compliant compact JWS object with a signature that validates against a currently active operation key, and contains the following payload values:<pre class="language-json"><code class="language-json"><span class="token punctuation">{</span>
  <span class="token property">"protected"</span><span class="token operator">:</span> <span class="token punctuation">{</span>...<span class="token punctuation">}</span><span class="token punctuation">,</span>
  <span class="token property">"payload"</span><span class="token operator">:</span> <span class="token punctuation">{</span>
      <span class="token property">"delta_hash"</span><span class="token operator">:</span> DELTA_HASH
  <span class="token punctuation">}</span><span class="token punctuation">,</span>
  <span class="token property">"signature"</span><span class="token operator">:</span> SIGNATURE_STRING
<span class="token punctuation">}</span>
</code></pre>
<ul>
<li>The JWS <code>payload</code> object <strong><strong>MUST</strong></strong> contain a <code>delta_hash</code> property, and its value <strong><strong>MUST</strong></strong> be a hash of the decoded <a href="#update-delta-object"><em>Update Operation Delta Object</em></a>, generated via the <a href="#hashing-process">Hashing Process</a>.</li>
</ul>
</li>
</ol>
<h3 id="recover"><a class="toc-anchor" href="#recover">§</a> Recover</h3>
<p>Use the following process to recover a Sidetree-based DID:</p>
<ol>
<li>Retrieve the <em>Recovery Reveal Value</em> that matches the previously anchored <em>Recovery Commitment</em>. This value will be used in constructing an <a href="#anchor-file-recovery-entry"><em>Anchor File Recovery Entry</em></a> for the DID being recovered.</li>
<li>Generate and retain a <a href="#commitment-value"><code>COMMITMENT_VALUE</code></a> for use in the next Recovery operation, herein referred to as the <em>Recovery Reveal Value</em>.</li>
<li>Generate a <a href="#recovery-commitment" id="recovery-commitment"><em>Recovery Commitment</em></a> hash using the <a href="#hashing-process">Hashing Process</a> to generate a hash of the <a href="#commitment-value"><code>COMMITMENT_VALUE</code></a>, and retain the resulting hash value for inclusion in an <a href="#anchor-file">Anchor File</a>.</li>
<li>Generate and retain a <a href="#commitment-value"><code>COMMITMENT_VALUE</code></a> for use in the next Update operation, herein referred to as the <em>Update Reveal Value</em>.</li>
<li>Generate an <em>Update Commitment</em> hash using the <a href="#hashing-process">Hashing Process</a> to generate a hash of the <em>Update Reveal Value</em>, and retain the resulting hash value for inclusion in an <a href="#anchor-file">Anchor File</a>.</li>
<li>Optionally, the recovering entity MAY generate a new key pair, via the <a href="#key-algorithm"><code>KEY_ALGORITHM</code></a>, for inclusion in the <a href="#anchor-file">Anchor File</a> (to support key rolling, etc.). The private key <strong><strong>MUST</strong></strong> be securely stored for use in subsequent <a href="#recover">Recovery</a> operations.</li>
<li>Generate an encoded representation of the following object using the implementation’s [<code>DATA_ENCODING_SCHEME</code>], herein referred to as the <a href="#recover-delta-object" id="recover-delta-object"><em>Recovery Operation Delta Object</em></a>, composed as follows:<pre class="language-json"><code class="language-json"><span class="token punctuation">{</span>
  <span class="token property">"patches"</span><span class="token operator">:</span> <span class="token punctuation">[</span> PATCH_<span class="token number">1</span><span class="token punctuation">,</span> PATCH_<span class="token number">2</span><span class="token punctuation">,</span> ... <span class="token punctuation">]</span><span class="token punctuation">,</span>
  <span class="token property">"update_commitment"</span><span class="token operator">:</span> HASH_OF_UPDATE_COMMITMENT_VALUE
<span class="token punctuation">}</span>
</code></pre>
<ul>
<li>The object <strong><strong>MUST</strong></strong> contain a <code>patches</code> property, and its value <strong><strong>MUST</strong></strong> be an array of <a href="#did-state-patches">DID State Patches</a>.</li>
<li>The object <strong><strong>MUST</strong></strong> contain a <code>update_commitment</code> property, and its value <strong><strong>MUST</strong></strong> be the <em>Update Commitment</em>, as described above.</li>
</ul>
</li>
<li>Generate an encoded representation of the following object using the implementation’s <a href="#data-encoding-scheme"><code>DATA_ENCODING_SCHEME</code></a>, herein referred to as the <a href="#recovery-signed-data-object" id="recovery-signed-data-object"><em>Recovery Operation Signed Data Object</em></a>. The object <strong><strong>MUST</strong></strong> be a <a href="https://tools.ietf.org/html/rfc7515">IETF RFC 7515</a> compliant compact JWS object with a signature that validates against the currently active recovery key, and contains the following <code>payload</code> values:<pre class="language-json"><code class="language-json"><span class="token punctuation">{</span>
  <span class="token property">"protected"</span><span class="token operator">:</span> <span class="token punctuation">{</span>...<span class="token punctuation">}</span><span class="token punctuation">,</span>
  <span class="token property">"payload"</span><span class="token operator">:</span> <span class="token punctuation">{</span>
      <span class="token property">"recovery_commitment"</span><span class="token operator">:</span> COMMITMENT_HASH<span class="token punctuation">,</span>
      <span class="token property">"delta_hash"</span><span class="token operator">:</span> DELTA_HASH<span class="token punctuation">,</span>
      <span class="token property">"recovery_key"</span><span class="token operator">:</span> JWK_OBJECT
  <span class="token punctuation">}</span><span class="token punctuation">,</span>
  <span class="token property">"signature"</span><span class="token operator">:</span> SIGNATURE_STRING
<span class="token punctuation">}</span>
</code></pre>
<ul>
<li>The JWS <code>payload</code> object <strong><strong>MUST</strong></strong> contain a <code>delta_hash</code> property, and its value <strong><strong>MUST</strong></strong> be a hash of the decoded <a href="#recover-delta-object"><em>Recovery Operation Delta Object</em></a>, generated via the <a href="#hashing-process">Hashing Process</a>.</li>
<li>The JWS <code>payload</code> object <strong><strong>MUST</strong></strong> contain a <code>recovery_commitment</code> property, and its value <strong><strong>MUST</strong></strong> be the next <a href="#recovery-commitment"><em>Recovery Commitment</em></a>, as described above.</li>
<li>The JWS <code>payload</code> object MAY include a <code>recovery_key</code> property, and if included, its value <strong><strong>MUST</strong></strong> be an <a href="https://tools.ietf.org/html/rfc7517">IETF RFC 7517</a> compliant JWK representation of a public key, as described above.</li>
</ul>
</li>
</ol>
<h3 id="deactivate"><a class="toc-anchor" href="#deactivate">§</a> Deactivate</h3>
<p>The following process must be used to deactivate a Sidetree-based DID:</p>
<ol>
<li>Retrieve the <em>Recovery Reveal Value</em> that matches the previously anchored <em>Recovery Commitment</em>.</li>
<li>Generate an encoded representation of the following object using the implementation’s <a href="#data-encoding-scheme"><code>DATA_ENCODING_SCHEME</code></a>, herein referred to as the <a href="#deactivate-signed-data-object" id="deactivate-signed-data-object"><em>Deactivate Operation Signed Data Object</em></a>. The object <strong><strong>MUST</strong></strong> be a <a href="https://tools.ietf.org/html/rfc7515">IETF RFC 7515</a> compliant compact JWS object with a signature that validates against the currently active recovery key, and contains the following payload values:<pre class="language-json"><code class="language-json"><span class="token punctuation">{</span> <span class="token comment">// Base64URL encoded, compact JWS</span>
  <span class="token property">"protected"</span><span class="token operator">:</span> <span class="token punctuation">{</span>...<span class="token punctuation">}</span><span class="token punctuation">,</span>
  <span class="token property">"payload"</span><span class="token operator">:</span> <span class="token punctuation">{</span>
    <span class="token property">"did_suffix"</span><span class="token operator">:</span> SUFFIX_STRING<span class="token punctuation">,</span>
    <span class="token property">"recovery_reveal_value"</span><span class="token operator">:</span> REVEAL_VALUE
  <span class="token punctuation">}</span><span class="token punctuation">,</span>
  <span class="token property">"signature"</span><span class="token operator">:</span> SIGNATURE_STRING
<span class="token punctuation">}</span>
</code></pre>
<ul>
<li>The JWS <code>payload</code> object <strong><strong>MUST</strong></strong> contain a <code>did_suffix</code> property, and its value <strong><strong>MUST</strong></strong> be the <a href="#did-suffix">DID Suffix</a> of the DID the operation pertains to.</li>
<li>The JWS <code>payload</code> object <strong><strong>MUST</strong></strong> contain a <code>recovery_reveal_value</code> property, and its value <strong><strong>MUST</strong></strong> be the last recovery <a href="#commitment-value"><code>COMMITMENT_VALUE</code></a>.</li>
</ul>
</li>
</ol>
<h2 id="did-state-patches"><a class="toc-anchor" href="#did-state-patches">§</a> DID State Patches</h2>
<p>Sidetree defines a general format for patching DID State, called <em>Patch Actions</em>, for describing mutations of a DID’s metadata state. Sidetree further defines a standard set of <em>Patch Actions</em> (below) implementers MAY use to facilitate patching within their implementations. Support of the standard set of <em>Patch Actions</em> defined herein IS NOT required, but implementers <strong><strong>MUST</strong></strong> use the <em>Patch Action</em> format for defining patch mechanisms within their implementation. The general <em>Patch Action</em> format is defined as follows:</p>
<pre class="language-json"><code class="language-json"><span class="token punctuation">{</span>
  <span class="token property">"action"</span><span class="token operator">:</span> <span class="token string">"add-public-keys"</span><span class="token punctuation">,</span>
  ...
<span class="token punctuation">}</span>

<span class="token punctuation">{</span>
  <span class="token property">"action"</span><span class="token operator">:</span> <span class="token string">"-custom-action"</span><span class="token punctuation">,</span>
  ...
<span class="token punctuation">}</span>
</code></pre>
<ol>
<li><em>Patch Actions</em> <strong><strong>MUST</strong></strong> be represented as JSON objects.</li>
<li><em>Patch Action</em> objects <strong><strong>MUST</strong></strong> include an <code>action</code> property, and its value <strong><strong>SHOULD</strong></strong> be one of the standard <em>Patch Action</em> types listed in below, or, if the implementer chooses to create a custom <em>Patch Action</em>, a kebab-case string (dash-delimited lowercase words) with a leading dash, to indicate a custom <em>Patch Action</em>, for example: <code>-custom-action</code>.
<ul>
<li><code>add-public-keys</code></li>
<li><code>remove-public-keys</code></li>
<li><code>add-service-endpoints</code></li>
<li><code>remove-service-endpoints</code></li>
<li><code>ietf-json-patch</code></li>
</ul>
</li>
</ol>
<h3 id="standard-patch-actions"><a class="toc-anchor" href="#standard-patch-actions">§</a> Standard Patch Actions</h3>
<p>The following set of standard <em>Patch Actions</em> are specified to help align on a common set of <em>Patch Actions</em> that provide a predictable usage patter across Sidetree-based DID Method implementations.</p>
<h4 id="add-public-keys"><a class="toc-anchor" href="#add-public-keys">§</a> <code>add-public-keys</code></h4>
<div id="example-33" class="notice example"><a class="notice-link" href="#example-33">EXAMPLE</a><pre class="language-json"><code class="language-json"><span class="token punctuation">{</span>
  <span class="token property">"action"</span><span class="token operator">:</span> <span class="token string">"add-public-keys"</span><span class="token punctuation">,</span>
  <span class="token property">"public_keys"</span><span class="token operator">:</span> <span class="token punctuation">[</span>
    <span class="token punctuation">{</span>
      <span class="token property">"id"</span><span class="token operator">:</span> <span class="token string">"key1"</span><span class="token punctuation">,</span>
      <span class="token property">"usage"</span><span class="token operator">:</span> <span class="token punctuation">[</span><span class="token string">"ops"</span><span class="token punctuation">]</span><span class="token punctuation">,</span>
      <span class="token property">"type"</span><span class="token operator">:</span> <span class="token string">"EcdsaSecp256k1VerificationKey2019"</span><span class="token punctuation">,</span>
      <span class="token property">"jwk"</span><span class="token operator">:</span> <span class="token punctuation">{</span>...<span class="token punctuation">}</span>
    <span class="token punctuation">}</span>
  <span class="token punctuation">]</span>
<span class="token punctuation">}</span>
</code></pre>
</div>
<p>The <code>add-public-keys</code> <em>Patch Action</em> describes the addition of cryptographic keys associated with a given DID. For any part of an <code>add-public-keys</code> <em>Patch Action</em> to be applied to the DID’s state, all specified conditions <strong><strong>MUST</strong></strong> be met for all properties and values, else the patch <strong><strong>MUST</strong></strong> be discarded in its entirety. To construct an <code>add-public-keys</code> patch, compose an object as follows:</p>
<ol>
<li>The object <strong><strong>MUST</strong></strong> include an <code>action</code> property, and its value <strong><strong>MUST</strong></strong> be <code>add-public-keys</code>.</li>
<li>The object <strong><strong>MUST</strong></strong> include a <code>public_keys</code> property, and its value <strong><strong>MUST</strong></strong> be an array.</li>
<li>Each key being added <strong><strong>MUST</strong></strong> be represented by an entry in the <code>public_keys</code> array, and each entry must be an object composed as follows:
<ol>
<li>The object <strong><strong>MUST</strong></strong> include an <code>id</code> property, and its value <strong><strong>MUST</strong></strong> be a string with no more than twenty (20) ASCII encoded characters. If the value is not of the correct type or exceeds the specified length, the entire <em>Patch Action</em> <strong><strong>MUST</strong></strong> be discarded, without any of it being used to modify the DID’s state.</li>
<li>The object <strong><strong>MUST</strong></strong> include a <code>type</code> property, and its value <strong><strong>MUST</strong></strong> be the identifier type string of a registered <a href="https://w3c-ccg.github.io/ld-cryptosuite-registry/">Cryptographic Suite</a> that supports the <code>publicKeyJwk</code> representation (examples below). If the value is not a registered type, or of a type that does not support the <code>publicKeyJwk</code> representation, the entire <em>Patch Action</em> <strong><strong>MUST</strong></strong> be discarded, without any of it being used to modify the DID’s state.
<ul>
<li><code>EcdsaSecp256k1VerificationKey2019</code></li>
<li><code>JwsVerificationKey2020</code></li>
</ul>
</li>
<li>The object <strong><strong>MUST</strong></strong> include a <code>jwk</code> property, and its value <strong><strong>MUST</strong></strong> be a public key expressed as a <a href="https://tools.ietf.org/html/rfc7517">IETF RFC 7517</a> compliant JWK representation for a <a href="#key-algorithm"><code>KEY_ALGORITHM</code></a> supported by the implementation. If the value is not a compliant JWK representation, the entire <em>Patch Action</em> <strong><strong>MUST</strong></strong> be discarded, without any of it being used to modify the DID’s state.</li>
<li>The object <strong><strong>MUST</strong></strong> include a <code>usage</code> property, and its value <strong><strong>MUST</strong></strong> be an array that includes one or more of the strings listed below. If the value is not of the correct type or contains any string not listed below, the entire <em>Patch Action</em> <strong><strong>MUST</strong></strong> be discarded, without any of it being used to modify the DID’s state.
<ul>
<li><strong><code>ops</code></strong>: the key <strong><strong>MUST</strong></strong> be allowed to sign operations for the DID. If no other string is present in the <code>usage</code> array, the key <strong><strong>SHOULD NOT</strong></strong> be projected into the output DID Document. If the <code>ops</code> string is present, the implementer MAY choose to include a DID Document compliant public key entry for it in its <a href="https://w3c-ccg.github.io/did-resolution/#example">Method-specific resolution metadata</a> output.</li>
<li><strong><code>general</code></strong>: the key <strong><strong>MUST</strong></strong> be included in the <code>public_keys</code> section of the resolved <em>DID Document</em>.</li>
<li><strong><code>auth</code></strong>: the key <strong><strong>MUST</strong></strong> be included in the <code>authentication</code> section of the resolved <em>DID Document</em>, as follows:
<ul>
<li>If the <code>general</code> usage value IS NOT present in the <code>usage</code> array, the key descriptor object <strong><strong>MUST</strong></strong> be included directly in the <code>authentication</code> section of the resolved <em>DID Document</em>.</li>
<li>If the <code>general</code> usage value IS present in the <code>usage</code> array, the key descriptor object <strong><strong>MUST</strong></strong> be directly included in the <code>public_keys</code> section of the resolved <em>DID Document</em>, and <strong><strong>MUST</strong></strong> be included by <a href="https://w3c.github.io/did-core/#relative-did-urls">relative DID URL reference</a> in the <code>authentication</code> section.</li>
</ul>
</li>
<li><strong><code>agreement</code></strong>: the key <strong><strong>MUST</strong></strong> be included in the <code>keyAgreement</code> section of the resolved <em>DID Document</em>, as follows:
<ul>
<li>If the <code>general</code> usage value IS NOT present in the <code>usage</code> array, the key descriptor object <strong><strong>MUST</strong></strong> be included directly in the <code>keyAgreement</code> section of the resolved <em>DID Document</em>.</li>
<li>If the <code>general</code> usage value IS present in the <code>usage</code> array, the key descriptor object <strong><strong>MUST</strong></strong> be directly included in the <code>public_keys</code> section of the resolved <em>DID Document</em>, and <strong><strong>MUST</strong></strong> be included by <a href="https://w3c.github.io/did-core/#relative-did-urls">relative DID URL reference</a> in the <code>keyAgreement</code> section.</li>
</ul>
</li>
<li><strong><code>assertion</code></strong>: the key <strong><strong>MUST</strong></strong> be included in the <code>assertionMethod</code> section of the resolved <em>DID Document</em>, as follows:
<ul>
<li>If the <code>general</code> usage value IS NOT present in the <code>usage</code> array, the key descriptor object <strong><strong>MUST</strong></strong> be included directly in the <code>assertionMethod</code> section of the resolved <em>DID Document</em>.</li>
<li>If the <code>general</code> usage value IS present in the <code>usage</code> array, the key descriptor object <strong><strong>MUST</strong></strong> be directly included in the <code>public_keys</code> section of the resolved <em>DID Document</em>, and <strong><strong>MUST</strong></strong> be included by <a href="https://w3c.github.io/did-core/#relative-did-urls">relative DID URL reference</a> in the <code>assertionMethod</code> section.</li>
</ul>
</li>
</ul>
</li>
</ol>
</li>
</ol>
<h4 id="remove-public-keys"><a class="toc-anchor" href="#remove-public-keys">§</a> <code>remove-public-keys</code></h4>
<div id="example-34" class="notice example"><a class="notice-link" href="#example-34">EXAMPLE</a><pre class="language-json"><code class="language-json"><span class="token punctuation">{</span>
  <span class="token property">"action"</span><span class="token operator">:</span> <span class="token string">"remove-public-keys"</span><span class="token punctuation">,</span>
  <span class="token property">"public_keys"</span><span class="token operator">:</span> <span class="token punctuation">[</span><span class="token string">"key1"</span><span class="token punctuation">,</span> <span class="token string">"key2"</span><span class="token punctuation">]</span>
<span class="token punctuation">}</span>
</code></pre>
</div>
<p>The <code>remove-public-keys</code> <em>Patch Action</em> describes the removal of cryptographic keys associated with a given DID. For any part of an <code>remove-public-keys</code> <em>Patch Action</em> to be applied to the DID’s state, all specified conditions <strong><strong>MUST</strong></strong> be met for all properties and values, else the patch <strong><strong>MUST</strong></strong> be discarded in its entirety. To construct a <code>remove-public-keys</code> <em>Patch Action</em>, compose an object as follows:</p>
<ol>
<li>The object <strong><strong>MUST</strong></strong> include an <code>action</code> property, and its value <strong><strong>MUST</strong></strong> be <code>remove-public-keys</code>.</li>
<li>The object <strong><strong>MUST</strong></strong> include a <code>public_keys</code> property, and its value <strong><strong>MUST</strong></strong> be an array of key IDs that correspond with keys presently associated with the DID that are to be removed. If the value is not of the correct type or includes a string value that is not associated with a key in the document, the entire <em>Patch Action</em> <strong><strong>MUST</strong></strong> be discarded, without any of it being used to modify the DID’s state.</li>
</ol>
<h4 id="add-service-endpoints"><a class="toc-anchor" href="#add-service-endpoints">§</a> <code>add-service-endpoints</code></h4>
<div id="example-35" class="notice example"><a class="notice-link" href="#example-35">EXAMPLE</a><pre class="language-json"><code class="language-json"><span class="token punctuation">{</span>
  <span class="token property">"action"</span><span class="token operator">:</span> <span class="token string">"add-service-endpoints"</span><span class="token punctuation">,</span>
  <span class="token property">"service_endpoints"</span><span class="token operator">:</span> <span class="token punctuation">[</span>
    <span class="token punctuation">{</span>
      <span class="token property">"id"</span><span class="token operator">:</span> <span class="token string">"sds1"</span><span class="token punctuation">,</span>
      <span class="token property">"type"</span><span class="token operator">:</span> <span class="token string">"SecureDataStore"</span><span class="token punctuation">,</span>
      <span class="token property">"uri"</span><span class="token operator">:</span> <span class="token string">"http://hub.my-personal-server.com"</span>
    <span class="token punctuation">}</span><span class="token punctuation">,</span>
    <span class="token punctuation">{</span>
      <span class="token property">"id"</span><span class="token operator">:</span> <span class="token string">"sds2"</span><span class="token punctuation">,</span>
      <span class="token property">"type"</span><span class="token operator">:</span> <span class="token string">"SecureDataStore"</span><span class="token punctuation">,</span>
      <span class="token property">"uri"</span><span class="token operator">:</span> <span class="token string">"http://some-cloud.com/hub"</span>
    <span class="token punctuation">}</span>
  <span class="token punctuation">]</span>
<span class="token punctuation">}</span>
</code></pre>
</div>
<p>The <code>add-service-endpoints</code> <em>Patch Action</em> describes the addition of <a href="https://w3c.github.io/did-core/#service-endpoints">Service Endpoints</a> to a DID’s state. For any part of an <code>add-service-endpoints</code> <em>Patch Action</em> to be applied to the DID’s state, all specified conditions <strong><strong>MUST</strong></strong> be met for all properties and values, else the patch <strong><strong>MUST</strong></strong> be discarded in its entirety. To construct an <code>add-service-endpoints</code> patch, compose an object as follows:</p>
<ol>
<li>The object <strong><strong>MUST</strong></strong> include an <code>action</code> property, and its value <strong><strong>MUST</strong></strong> be <code>add-service-endpoints</code>.</li>
<li>The object <strong><strong>MUST</strong></strong> include a <code>service_endpoints</code> property, and its value <strong><strong>MUST</strong></strong> be an array. If the value is not of the correct type, the entire <em>Patch Action</em> <strong><strong>MUST</strong></strong> be discarded, without any of it being used to modify the DID’s state.</li>
<li>Each service being added <strong><strong>MUST</strong></strong> be represented by an entry in the <code>service_endpoints</code> array, and each entry must be an object composed as follows:
<ol>
<li>The object <strong><strong>MUST</strong></strong> include an <code>id</code> property, and its value <strong><strong>MUST</strong></strong> be a string with a length of no more than twenty (20) ASCII encoded characters. If the value is not of the correct type or exceeds the specified length, the entire <em>Patch Action</em> <strong><strong>MUST</strong></strong> be discarded, without any of it being used to modify the DID’s state.</li>
<li>The object <strong><strong>MUST</strong></strong> include a <code>type</code> property, and its value <strong><strong>MUST</strong></strong> be a string with a length of no more than thirty (30) ASCII encoded characters. If the value is not a string or exceeds the specified length, the entire <em>Patch Action</em> <strong><strong>MUST</strong></strong> be discarded, without any of it being used to modify the DID’s state.</li>
<li>The object <strong><strong>MUST</strong></strong> include a <code>uri</code> property, and its value <strong><strong>MUST</strong></strong> be a valid URI string (including a scheme segment: i.e. http://, git://) with a length of no more than one hundred (100) ASCII encoded characters. If the value is not a valid URI or exceeds the specified length, the entire <em>Patch Action</em> <strong><strong>MUST</strong></strong> be discarded, without any of it being used to modify the DID’s state.</li>
</ol>
</li>
</ol>
<h4 id="remove-service-endpoints"><a class="toc-anchor" href="#remove-service-endpoints">§</a> <code>remove-service-endpoints</code></h4>
<div id="example-36" class="notice example"><a class="notice-link" href="#example-36">EXAMPLE</a><pre class="language-json"><code class="language-json"><span class="token punctuation">{</span>
  <span class="token property">"action"</span><span class="token operator">:</span> <span class="token string">"remove-service-endpoints"</span><span class="token punctuation">,</span>
  <span class="token property">"ids"</span><span class="token operator">:</span> <span class="token punctuation">[</span><span class="token string">"sds1"</span><span class="token punctuation">,</span> <span class="token string">"sds2"</span><span class="token punctuation">]</span>
<span class="token punctuation">}</span>
</code></pre>
</div>
<p>The <code>remove-service-endpoints</code> <em>Patch Action</em> describes the removal of cryptographic keys associated with a given DID. For any part of an <code>remove-service-endpoints</code> <em>Patch Action</em> to be applied to the DID’s state, all specified conditions <strong><strong>MUST</strong></strong> be met for all properties and values, else the patch <strong><strong>MUST</strong></strong> be discarded in its entirety. To construct a <code>remove-service-endpoints</code> <em>Patch Action</em>, compose an object as follows:</p>
<ol>
<li>The object <strong><strong>MUST</strong></strong> include an <code>action</code> property, and its value <strong><strong>MUST</strong></strong> be <code>remove-service-endpoints</code>.</li>
<li>The object <strong><strong>MUST</strong></strong> include a <code>ids</code> property, and its value <strong><strong>MUST</strong></strong> be an array of Service Endpoint IDs that correspond with Service Endpoints presently associated with the DID that are to be removed.</li>
</ol>
<h4 id="ietf-json-patch"><a class="toc-anchor" href="#ietf-json-patch">§</a> <code>ietf-json-patch</code></h4>
<p>The <code>ietf-json-patch</code> Patch Action describes a mechanism for modifying a DID’s state using <a href="https://tools.ietf.org/html/rfc6902">IETF JSON Patch</a>. To construct a <code>ietf-json-patch</code> <em>Patch Action</em>, compose an object as follows:</p>
<ol>
<li>The object <strong><strong>MUST</strong></strong> include an <code>action</code> property, and its value <strong><strong>MUST</strong></strong> be <code>ietf-json-patch</code>.</li>
<li>The object <strong><strong>MUST</strong></strong> include a <code>patches</code> property, and its value <strong><strong>MUST</strong></strong> be an array of <a href="https://tools.ietf.org/html/rfc6902">IETF JSON Patch</a> operation objects.</li>
</ol>
<div id="1-4" class="notice example"><a class="notice-link" href="#1-4">EXAMPLE</a><pre class="language-json"><code class="language-json"><span class="token punctuation">{</span>
  <span class="token property">"action"</span><span class="token operator">:</span> <span class="token string">"ietf-json-patch"</span><span class="token punctuation">,</span>
  <span class="token property">"patches"</span><span class="token operator">:</span> <span class="token punctuation">[</span>
    <span class="token punctuation">{</span> <span class="token property">"op"</span><span class="token operator">:</span> <span class="token string">"add"</span><span class="token punctuation">,</span> ... <span class="token punctuation">}</span><span class="token punctuation">,</span>
    <span class="token punctuation">{</span> <span class="token property">"op"</span><span class="token operator">:</span> <span class="token string">"remove"</span><span class="token punctuation">,</span> ... <span class="token punctuation">}</span><span class="token punctuation">,</span>
    <span class="token punctuation">{</span> <span class="token property">"op"</span><span class="token operator">:</span> <span class="token string">"replace"</span><span class="token punctuation">,</span> ... <span class="token punctuation">}</span><span class="token punctuation">,</span>
    <span class="token punctuation">{</span> <span class="token property">"op"</span><span class="token operator">:</span> <span class="token string">"move"</span><span class="token punctuation">,</span> ... <span class="token punctuation">}</span><span class="token punctuation">,</span>
    <span class="token punctuation">{</span> <span class="token property">"op"</span><span class="token operator">:</span> <span class="token string">"copy"</span><span class="token punctuation">,</span> ... <span class="token punctuation">}</span>
  <span class="token punctuation">]</span>
<span class="token punctuation">}</span>
</code></pre>
</div>
<div id="2-4" class="notice example"><a class="notice-link" href="#2-4">EXAMPLE</a><pre class="language-json"><code class="language-json"><span class="token punctuation">{</span>
  <span class="token property">"action"</span><span class="token operator">:</span> <span class="token string">"ietf-json-patch"</span><span class="token punctuation">,</span>
  <span class="token property">"patches"</span><span class="token operator">:</span> <span class="token punctuation">[</span>
    <span class="token punctuation">{</span>
      <span class="token property">"op"</span><span class="token operator">:</span> <span class="token string">"replace"</span><span class="token punctuation">,</span>
      <span class="token property">"path"</span><span class="token operator">:</span> <span class="token string">"/service"</span><span class="token punctuation">,</span>
      <span class="token property">"value"</span><span class="token operator">:</span> <span class="token punctuation">[</span>
          <span class="token punctuation">{</span>
              <span class="token property">"id"</span><span class="token operator">:</span> <span class="token string">"did:example:123#edv"</span><span class="token punctuation">,</span>
              <span class="token property">"type"</span><span class="token operator">:</span> <span class="token string">"EncryptedDataVault"</span><span class="token punctuation">,</span>
              <span class="token property">"serviceEndpoint"</span><span class="token operator">:</span> <span class="token string">"https://edv.example.com/"</span><span class="token punctuation">,</span>
          <span class="token punctuation">}</span><span class="token punctuation">,</span>
      <span class="token punctuation">]</span><span class="token punctuation">,</span>
      <span class="token punctuation">}</span>
  <span class="token punctuation">]</span>
<span class="token punctuation">}</span>
</code></pre>
</div>
<div id="warning-9" class="notice warning"><a class="notice-link" href="#warning-9">WARNING</a><p>Use of <code>ietf-json-patch</code> may result in unrecoverable states, similar to “Deactivated”.</p>
</div>
<div id="warning-10" class="notice warning"><a class="notice-link" href="#warning-10">WARNING</a><p>Use of <code>ietf-json-patch</code> may harm an implmentation’s ability to perform validation on operations at ingestion time, which could impact performance negatively.</p>
</div>
<h2 id="transaction-operation-processing"><a class="toc-anchor" href="#transaction-operation-processing">§</a> Transaction &amp; Operation Processing</h2>
<h3 id="transaction-anchoring"><a class="toc-anchor" href="#transaction-anchoring">§</a> Transaction Anchoring</h3>
<p>Once an Anchor File, Map File, and associated Chunk Files have been assembled for a given set of operations, a reference to the <a href="#anchor-file">Anchor File</a> must be embedded within the target ledger to enter the set of operations into the Sidetree implementation’s global state. The following process:</p>
<ol>
<li>Generate a transaction for the underlying ledger</li>
<li>Generate and include the following value, herein referred to as the <a href="#anchor-string" id="anchor-string"><em>Anchor String</em></a>, within the transaction:
<ol>
<li>Convert the total number of operations in the Chunk File to a 4 byte little endian string and encode it using the <a href="#data-encoding-scheme"><code>DATA_ENCODING_SCHEME</code></a>, herein referred to as the <em>Operation Count</em>.</li>
<li>Using the <a href="#cid-algorithm"><code>CID_ALGORITHM</code></a>, generate a CID for the Anchor File, herein referred to as the <em>Anchor File CID</em>.</li>
<li>Join the <em>Operation Count</em> and <em>Anchor File CID</em> with a <code>.</code> as follows:<pre class="language-js"><code class="language-js"><span class="token string">"ECcAAA"</span> <span class="token operator">+</span> <span class="token string">"."</span> <span class="token operator">+</span> <span class="token string">"QmWd5PH6vyRH5kMdzZRPBnf952dbR4av3Bd7B2wBqMaAcf"</span>
</code></pre>
</li>
<li>Embed the <em>Anchor String</em> in the transaction such that it can be located and parsed by any party that traverses the history of the target ledger.</li>
</ol>
</li>
<li>If the implementation implements a <a href="#proof-of-fee">per-op fee</a>, ensure the transaction includes the fee amount required for the number of operations being anchored.</li>
<li>Encode the transaction with any other data or values required for inclusion by the target ledger, and broadcast it.</li>
</ol>
<h3 id="cas-file-propagation"><a class="toc-anchor" href="#cas-file-propagation">§</a> CAS File Propagation</h3>
<p>To ensure other nodes of the implementation can retrieve the <a href="#file-structures">operation files</a> required to ingest the included operations and update the states of the DIDs it contains, the implementer must ensure that the files associated with a given set of operations being anchored are available to peers seeking to request and replicate them across the CAS storage layer. Use the following procedure for propagating transaction-anchored CAS files:</p>
<ol>
<li>If the underlying ledger is subject to a period of inclusion delay (e.g. block time), implementers <strong><strong>SHOULD</strong></strong> wait until they receive minimal confirmation of inclusion before exposing/propagating the <a href="#file-structures">operation files</a> across the CAS network.</li>
<li>After confirmation is received, implementers <strong><strong>SHOULD</strong></strong> use the most effective means of proactive propagation the <a href="#cas-protocol"><code>CAS_PROTOCOL</code></a> supports.</li>
<li>A Sidetree-based implementation node that anchors operations should not assume other nodes on the CAS network will indefinitely retain and propagate the <a href="#file-structures">files</a> for a given set of operations they anchor. A node <strong><strong>SHOULD</strong></strong> retain and propagate any files related to the operations it anchors.</li>
</ol>
<h3 id="transaction-processing"><a class="toc-anchor" href="#transaction-processing">§</a> Transaction Processing</h3>
<p>Regardless of the ledger system an implementer chooses, the implementer <strong><strong>MUST</strong></strong> be able to sequence Sidetree-specific transactions within it in a deterministic order, such that any observer can derive the same order if the same logic is applied. The implementer MUST, either at the native transaction level or by some means of logical evaluation, assign Sidetree-specific transactions a <a href="#transaction-number"><em>Transaction Number</em></a>. <a href="#transaction-number"><em>Transaction Numbers</em></a> <strong><strong>MUST</strong></strong> be assigned to all Sidetree-specific transactions present in the underlying ledger after <a href="#genesis-time"><code>GENESIS_TIME</code></a>, regardless of whether or not they are valid.</p>
<ol>
<li>An implementer <strong><strong>MUST</strong></strong> develop implementation-specific logic that enables deterministic ordering and iteration of all protocol-related transactions in the underlying ledger, such that all operators of the implementation process them in the same order.</li>
<li>Starting at <a href="#genesis-time"><code>GENESIS_TIME</code></a>, begin iterating transactions using the implementation-specific logic.</li>
<li>For each transaction found during iteration that is determined to be a protocol-related transaction, process the transaction as follows:
<ol>
<li>Assign the transaction a <em>Transaction Number</em>.</li>
<li>If the implementation supports enforcement value locking, and the transaction is encoded in accordance with the implementation’s value locking format, skip the remaining steps and process the transaction as described in the <a href="#proof-of-fee">Proof of Fee</a> section on <a href="#value-locking">Value Locking</a>.</li>
<li>The <a href="#anchor-string"><em>Anchor String</em></a> <strong><strong>MUST</strong></strong> be formatted correctly - if it IS NOT, discard the transaction and continue iteration.</li>
<li>If the implementation DOES NOT support enforcement of a <a href="#proof-of-fee">per-operation fee</a>, skip this step. If enforcement of a <a href="#proof-of-fee">per-operation fee</a> is supported, ensure the transaction fee meets the <a href="#proof-of-fee">per-operation fee</a> requirements for inclusion - if it DOES NOT, discard the transaction and continue iteration.</li>
<li>If the implementation DOES NOT support enforcement of <a href="#value-locking">Value Locking</a>, skip this step. If enforcement of <a href="#value-locking">Value Locking</a> is supported, ensure the transaction’s fee meets the <a href="#value-locking">Value Locking</a> requirements for inclusion - if it does not, discard the transaction and continue iteration.</li>
<li>Parse the <a href="#anchor-string"><em>Anchor String</em></a> to derive the <em>Operation Count</em> and <em>Anchor File CID</em>.</li>
<li>Use the <a href="#cas-protocol"><code>CAS_PROTOCOL</code></a> to fetch the <a href="#anchor-file">Anchor File</a> using the <em>Anchor File CID</em>. If the file cannot be located, retain a reference that signifies the need to retry fetch of the file. If the file successfully retrieved, proceed to the next section on how to <a href="#anchor-file-processing">process an Anchor File</a></li>
</ol>
</li>
</ol>
<h3 id="anchor-file-processing"><a class="toc-anchor" href="#anchor-file-processing">§</a> Anchor File Processing</h3>
<p>The follow sequence of rules and processing steps must be followed to correctly process an <a href="#anchor-file">Anchor File</a>:</p>
<ol>
<li>The <a href="#anchor-file">Anchor File</a> <strong><strong>MUST NOT</strong></strong> exceed the <a href="#max-anchor-file-size"><code>MAX_ANCHOR_FILE_SIZE</code></a> - if it does, cease processing, discard the file data, and retain a reference that the file is to be ignored.</li>
<li>The <a href="#anchor-file">Anchor File</a> <strong><strong>MUST</strong></strong> validate against the protocol-defined <a href="#anchor-file">Anchor File</a> schema and construction rules - if it DOES NOT, cease processing, discard the file data, and retain a reference that the file is to be ignored.
<ul>
<li>While this rule is articulated in the <a href="#anchor-file">Anchor File</a> section of the specification, it should be emphasized to ensure accurate processing: an <a href="#anchor-file">Anchor File</a> <strong><strong>MUST NOT</strong></strong> include multiple operations in the <code>operations</code> section of the <a href="#anchor-file">Anchor File</a> for the same <a href="#did-suffix">DID Suffix</a> - if any duplicates are found, cease processing, discard the file data, and retain a reference that the file is to be ignored.</li>
</ul>
</li>
<li>If processing of rules 1 and 2 above resulted in successful validation of the Anchor File, initiate retrieval of the <a href="#map-file">Map File</a> via the <a href="#cas-protocol"><code>CAS_PROTOCOL</code></a> using the <a href="#map-file-property"><code>map_file</code></a> property’s  <em>CID</em> value. This is only a SUGGESTED point at which to begin retrieval of the Map File, not a blocking procedural step, so you may continue with processing before retrieval of the <a href="#map-file">Map File</a> is complete.</li>
<li>Iterate the <a href="#anchor-file-create-entry"><em>Anchor File Create Entries</em></a>, and for each entry, process as follows:
<ol>
<li>Derive the <a href="#did-suffix">DID Suffix</a> from the values present in the entry.</li>
<li>Ensure the <a href="#did-suffix">DID Suffix</a> of the operation entry has not been included in another valid operation that was previously processed in the scope of this Anchor File. If another previous, valid operation was already processed in the scope of this <a href="#anchor-file">Anchor File</a> for the same DID, do not process the operation and move to the next operation in the array.</li>
<li>Ensure there IS NOT an existing, valid <a href="#create">Create</a> entry for the same <a href="#did-suffix">DID Suffix</a> at a previous logical time in the implementation node’s observed state-history: If another valid <a href="#anchor-file-create-entry"><em>Anchor File Create Entry</em></a> has already registered a DID matching the same <a href="#did-suffix">DID Suffix</a> in any previously observed transaction preceding the current transaction in <a href="#ledger-time">Ledger Time</a>, do not process the operation and move to the next operation in the array.</li>
<li>Create an entry for the new DID within the implementation’s persistent storage, relative to the operation’s position in <a href="#ledger-time">Ledger Time</a>, to contain this and future operations of the DID.</li>
</ol>
</li>
<li>Iterate the <a href="#anchor-file-recovery-entry"><em>Anchor File Recovery Entries</em></a>, and for each entry, process as follows:
<ol>
<li>Ensure the <a href="#did-suffix">DID Suffix</a> of the operation entry has not been included in another valid operation that was previously processed in the scope of this Anchor File. If another previous, valid operation was already processed in the scope of this <a href="#anchor-file">Anchor File</a> for the same DID, do not process the operation and move to the next operation in the array.</li>
<li>Ensure there IS NOT an existing, valid <a href="#anchor-file-recovery-entry"><em>Anchor File Recovery Entry</em></a> for the same <a href="#did-suffix">DID Suffix</a>, with the same recovery reveal value, at a previous logical time in the implementation node’s observed state-history: If another valid <a href="#anchor-file-recovery-entry"><em>Anchor File Recovery Entry</em></a> has already recovered a DID matching the same <a href="#did-suffix">DID Suffix</a>, using the same recovery commitment in any previously observed transaction preceding the current transaction in <a href="#ledger-time">Ledger Time</a>, do not process the operation and move to the next operation in the array.</li>
<li>Create an entry for the operation in the implementation’s persistent storage, relative to the operation’s position in <a href="#ledger-time">Ledger Time</a>, and that of any previously observed operations for the same <a href="#did-suffix">DID Suffix</a>, if any are present.</li>
</ol>
</li>
<li>Iterate the <a href="#anchor-file">Anchor File</a> Deactivate Entries_](#anchor-file-deactivate-entry), and for each entry, process as follows:
<ol>
<li>Ensure the <a href="#did-suffix">DID Suffix</a> of the operation entry has not been included in another valid operation that was previously processed in the scope of this Anchor File. If another previous, valid operation was already processed in the scope of this <a href="#anchor-file">Anchor File</a> for the same DID, do not process the operation and move to the next operation in the array.</li>
<li>Concatenate the <a href="#did-suffix">DID Suffix</a> and the <em>Recovery Reveal Value</em> together and validate the signature present in the entry against the concatenated string value. If the signature is valid, update retained references to the DID to deactivate it. If the signature is invalid, do not process the operation and move to the next operation in the array.</li>
</ol>
</li>
</ol>
<div id="todo-9" class="notice todo"><a class="notice-link" href="#todo-9">TODO</a><p>Confirm how we handle ops where there was not a previous op found.</p>
</div>
<h3 id="map-file-processing"><a class="toc-anchor" href="#map-file-processing">§</a> Map File Processing</h3>
<p>The follow sequence of rules and processing steps must be followed to correctly process a Map File:</p>
<ol>
<li>The <a href="#map-file">Map File</a> <strong><strong>MUST NOT</strong></strong> exceed the <a href="#max-map-file-size"><code>MAX_MAP_FILE_SIZE</code></a> - if it does, cease processing, discard the file data, and retain a reference that the file is to be ignored.</li>
<li>The <a href="#map-file">Map File</a> <strong><strong>MUST</strong></strong> validate against the protocol-defined <a href="#map-file">Map File</a> schema and construction rules - if it DOES NOT, cease processing, discard the file data, and retain a reference that the file is to be ignored.</li>
<li>If processing of rules 1 and 2 above resulted in successful validation of the Map File, begin retrieval of the Chunk Files by iterating the <code>chunks</code> array and using the <a href="#cas-protocol"><code>CAS_PROTOCOL</code></a> to fetch each entry’s <code>chunk_file_uri</code> (a <em>CID</em> based on the <a href="#cid-algorithm"><code>CID_ALGORITHM</code></a>. This is only a SUGGESTED point at which to begin retrieval of the Map File, not a blocking procedural step, so you may continue with processing before retrieval of the Chunk File chunks is complete.</li>
<li>Iterate the <a href="#map-file-update-entry"><em>Map File Update Entries</em></a>, and for each entry, process as follows:
<ol>
<li>Ensure the <a href="#did-suffix">DID Suffix</a> of the operation entry has not been included in another valid operation that was previously processed in the scope of the <a href="#map-file">Map File</a> or its parent <a href="#anchor-file">Anchor File</a>. If another previous, valid operation was already processed in the scope of this <a href="#anchor-file">Anchor File</a> for the same DID, do not process the operation and move to the next operation in the array.</li>
<li>Ensure there IS NOT an existing, valid <a href="#map-file-update-entry">Map File Update Entry</a> for the same <a href="#did-suffix">DID Suffix</a>, with the same update reveal value, at a previous logical time in the implementation node’s observed state-history: If another valid <a href="#map-file-update-entry">Map File Update Entry</a> has already update a DID matching the same <a href="#did-suffix">DID Suffix</a>, using the same update commitment in any previously observed transaction preceding the current transaction in <a href="#ledger-time">Ledger Time</a>, do not process the operation and move to the next operation in the array.</li>
<li>Create an entry for the operation in the implementation’s persistent storage, relative to the operation’s position in <a href="#ledger-time">Ledger Time</a>, and that of any previously observed operations for the same <a href="#did-suffix">DID Suffix</a>, if any are present.</li>
</ol>
</li>
<li>If the node is in a <a href="#light-node"><em>Light Node</em></a> configuration, retain a reference to the <a href="#chunk-files">Chunk Files</a> relative to the DIDs in the anchored batch for just-in-time fetch of the <a href="#chunk-files">Chunk Files</a> during DID resolution.</li>
</ol>
<h3 id="chunk-file-processing"><a class="toc-anchor" href="#chunk-file-processing">§</a> Chunk File Processing</h3>
<p>The follow sequence of rules and processing steps must be followed to correctly process a Chunk File chunk:</p>
<ol>
<li>The <a href="#chunk-file">Chunk File</a> chunk <strong><strong>MUST NOT</strong></strong> exceed the <a href="#max-chunk-file-size"><code>MAX_CHUNK_FILE_SIZE</code></a> - if it does, cease processing, discard the file data, and retain a reference that the file is to be ignored.</li>
<li>The <a href="#chunk-file">Chunk File</a> <strong><strong>MUST</strong></strong> validate against the protocol-defined <a href="#chunk-file">Chunk File</a> schema and construction rules - if it DOES NOT, cease processing, discard the file data, and retain a reference that the file is to be ignored.</li>
<li>In order to process <a href="#chunk-file-delta-entry"><em>Chunk File Delta Entries</em></a> in relation to the DIDs they are bound to, they must be mapped back to the Create, Recovery, and Update operation entries present in the <a href="#anchor-file">Anchor File</a> and <a href="#map-file">Map File</a>. To create this mapping, concatenate the <a href="#anchor-file-create-entry"><em>Anchor File Create Entries</em></a>, <a href="#anchor-file-recovery-entry"><em>Anchor File Recovery Entries</em></a>, <a href="#map-file-recovery-entry"><em>Map File Update Entries</em></a> into a single array, in that order, herein referred to as the <a href="#operation-delta-mapping-array" id="operation-delta-mapping-array">Operation Delta Mapping Array</a>. Pseudo-code example:<pre class="language-js"><code class="language-js"><span class="token keyword">let</span> mappingArray <span class="token operator">=</span> <span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token punctuation">.</span><span class="token function">concat</span><span class="token punctuation">(</span><span class="token constant">CREATE_ENTRIES</span><span class="token punctuation">,</span> <span class="token constant">RECOVERY_ENTRIES</span><span class="token punctuation">,</span> <span class="token constant">UPDATE_ENTRIES</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
</code></pre>
</li>
<li>With the <a href="#operation-delta-mapping-array">Operation Delta Mapping Array</a> assembled, iterate the <a href="#chunk-file-delta-entry"><em>Chunk File Delta Entries</em></a> from 0 index forward, processing each <a href="#chunk-file-delta-entry"><em>Chunk File Delta Entry</em></a> as follows:
<ol>
<li>Identify the operation entry from the <a href="#operation-delta-mapping-array">Operation Delta Mapping Array</a> at the same index as the current iteration and determine its <a href="#did-suffix">DID Suffix</a> (for <a href="#anchor-file-create-entry"><em>Anchor File Create Entries</em></a>, you will need to compute the <a href="#did-suffix">DID Suffix</a>). This is the DID the current iteration element maps to.</li>
<li>Insert the current <a href="#chunk-file-delta-entry"><em>Chunk File Delta Entry</em></a> into the persistent operation storage area designated for the matching DID in ledger-relative chronological order, in relation to any existing operations.</li>
</ol>
</li>
</ol>
<div id="note-15" class="notice note"><a class="notice-link" href="#note-15">NOTE</a><p>The assembly and processing of Chunk Files will change in a future update to the protocol, to accommodate the introduction of multiple chunk files. The current protocol version is designed around one Chunk File, but the scaffolding is present to move to multiple Chunk Files as development progresses.</p>
</div>
<div id="todo-10" class="notice todo"><a class="notice-link" href="#todo-10">TODO</a><p>Add the ordering rules for ensuring the order matches the order expected from the Anchor/Map files</p>
</div>
<h2 id="proof-of-fee"><a class="toc-anchor" href="#proof-of-fee">§</a> Proof of Fee</h2>
<p>Sidetree implementations MAY choose to impose a per-op fee that is used to gate the transaction on the target chain is required to include a deterministic, protocol-specified fee, based on the number of DID operations they seek to include via the on-chain transaction. The deterministic protocol rules for the default configuration are still under discussion, but the following are roughly represent the direction under discussion:</p>
<ol>
<li>Simple inclusion of a transaction in a block will enable the transaction writer to include a baseline of N operations</li>
<li>Any number of operations that exceed N will be subject to proof that a fee was paid that meets or exceeds a required amount, determined as follows:</li>
<li>Let the block range R include the last block the node believes to be the latest confirmed and the 9 blocks that precede it.</li>
<li>Compute an array of median fees M, wherein the result of each computation is the median of all transactions fees in each block, less any Sidetree-bearing transactions.</li>
<li>Let the target fee F be the average of all the values contained in M.</li>
<li>Let the per operation cost C be F divided by the baseline amount N.</li>
<li>To test the batch for adherence to the Proof of Fee requirement, divide the number of operations in the batch by the fee paid in the host transaction, and ensure that the resulting per operation amount exceeds the required per operation cost C.</li>
</ol>
<h3 id="value-locking"><a class="toc-anchor" href="#value-locking">§</a> Value Locking</h3>
<h2 id="resolution"><a class="toc-anchor" href="#resolution">§</a> Resolution</h2>
<h3 id="operation-compilation"><a class="toc-anchor" href="#operation-compilation">§</a> Operation Compilation</h3>
<ol>
<li>
<p>Upon invocation of resolution, retrieve all observed operations for the <a href="#did-unique-suffix">DID Unique Suffix</a> of the DID URI being resolved.</p>
</li>
<li>
<p>If record of the DID being published has been observed, proceed to Step 3. If there is no observed record of the DID being published, skip all remaining <a href="#operation-compilation">Operation Compilation</a> steps and process the DID as follows:</p>
<ol>
<li>If the DID URI <strong><strong>does not</strong></strong> include a <code>-METHOD-initial-state</code> <em>DID URL Parameter</em> with a Method-specific prefix that matches the name of the implementation, abort resolution and return <em>Unresolvable</em>.</li>
<li>If the DID URI <strong><strong>does</strong></strong> include a <code>-METHOD-initial-state</code> <em>DID URL Parameter</em> with a Method-specific prefix that matches the name of the implementation, process the DID as follows:
<ol>
<li>Split the <code>-METHOD-initial-state</code> <em>DID URL Parameter</em> string value by the period (<code>.</code>) character, and ensure the resulting array contains <strong><strong>exactly</strong></strong> two (2) members. If the resulting array contains fewer than two members, abort resolution and return <em>Unresolvable</em>.</li>
<li>Using the implementation’s <a href="#data-encoding-scheme"><code>DATA_ENCODING_SCHEME</code></a>, decode the both members of the array and retain the resulting values. If the values fail to properly decode in accordance with the implementation’s <a href="#data-encoding-scheme"><code>DATA_ENCODING_SCHEME</code></a>, abort resolution and return <em>Unresolvable</em>.</li>
<li>Let the decoded value at the 0 index be the DID’s <a href="#create-suffix-data-object"><em>Create Operation Suffix Data Object</em></a>, and validate it as such. If the value is found to be a valid <a href="#create-suffix-data-object"><em>Create Operation Suffix Data Object</em></a>, proceed, if the value fails validation, abort resolution and return <em>Unresolvable</em>.</li>
<li>Let the decoded value at the 0 index be the DID’s <a href="#create-delta-object"><em>Create Operation Delta Object</em></a> (which is present in a <a href="#chunk-file-delta-entry"><em>Chunk File Delta Entry</em></a> for published, anchored DIDs), and validate it as such. If the value is found to be a valid <a href="#create-delta-object"><em>Create Operation Delta Object</em></a> , proceed, if the value fails validation, abort resolution and return <em>Unresolvable</em>.</li>
<li>If all steps above are successful, internally flag the state of the DID as <em>Unpublished</em> and continue to Step 4 of the Operation Compilation process (<a href="#create-operation-processing">create operation processing</a>) as if the values decoded and validated in the steps above represent the only operation associated with the DID.</li>
</ol>
</li>
</ol>
</li>
<li>
<p>Ensure all operations for the DID are sorted in ascending <a href="#ledger-time"><code>Ledger Time</code></a> order.</p>
</li>
<li>
<p><a href="#create-operation-processing" id="create-operation-processing">Create operation processing</a>: begin iterating the operations from earliest in <a href="#ledger-time"><code>Ledger Time</code></a> forward, until a Create operation is found. If no Create operation is found, cease resolution of the DID and declare the DID unresolvable. If a Create operation is found, process the Create operation as follows:</p>
<ol>
<li>Retrieve the <a href="#chunk-file-delta-entry"><em>Chunk File Delta Entry</em></a> from the pre-processed <a href="#chunk-file">Chunk File</a> associated with the operation and proceed to the processing instruction, or, if the <a href="#chunk-file">Chunk File</a> has not yet been retrieved and processed (i.e. node is a <a href="#light-node"><em>Light Node</em></a> implementation, file was previously unavailable, etc.), perform the following steps:
<ol>
<li>Using the <a href="#cas-protocol"><code>CAS_PROTOCOL</code></a>, fetch the <a href="#chunk-files">Chunk File</a> using the associated <em>Chunk File URI</em>. If the file is unable to be retrieved:
<ol>
<li>Internally flag the state of the DID as <em>Non-Updateable</em>.</li>
<li>Skip all further Create operation processing steps and proceed to <a href="#post-create-operation-processing">post-Create operation processing</a>.</li>
</ol>
</li>
<li>Validate the <a href="#chunk-file">Chunk File</a> using the <a href="#chunk-file-processing">Chunk File Processing</a> procedure. If the <a href="#chunk-file">Chunk File</a> is valid, proceed, if the file is invalid:
<ol>
<li>Internally flag the state of the DID as <em>Non-Updateable</em>.</li>
<li>Skip all further Create operation processing steps and proceed to <a href="#post-create-operation-processing">post-Create operation processing</a>.</li>
</ol>
</li>
</ol>
</li>
<li>Validate the <a href="#chunk-file-delta-entry"><em>Chunk File Delta Entry</em></a>. If the <a href="#chunk-file-delta-entry"><em>Chunk File Delta Entry</em></a> is valid, proceed, if the Entry is invalid, let the state of the DID reflect an <em>Empty DID State</em>.</li>
<li>Generate a hash of the decoded <a href="#chunk-file-delta-entry"><em>Chunk File Delta Entry</em></a> via the <a href="#hashing-process">Hashing Process</a> and ensure the hash equals the value of the <a href="#create-suffix-data-object"><em>Create Operation Suffix Data Object</em></a> <code>delta_hash</code> property. If the values are exactly equal, proceed, if they are not:
<ol>
<li>Internally flag the state of the DID as <em>Non-Updateable</em>.</li>
<li>Skip all further Create operation processing steps and proceed to <a href="#post-create-operation-processing">post-Create operation processing</a>.</li>
</ol>
</li>
<li>Retain a reference to the <code>update_commitment</code> value of the <a href="#chunk-file-delta-entry"><em>Chunk File Delta Entry</em></a> for use in processing the next Update operation.</li>
<li>Begin iterating the <code>patches</code> array in the <a href="#chunk-file-delta-entry"><em>Chunk File Delta Entry</em></a>, and for each <a href="#did-state-patch">DID State Patch</a> entry, perform the following steps:
<ol>
<li>Validate the entry in accordance any requirements imposed by the <a href="#standard-patch-actions">Patch Action</a> type indicated by the <code>action</code> value of the entry. If the entry is valid, proceed, if the entry fails validation, skip the entry and proceed to the next entry.</li>
<li>Apply the patch as directed by the <a href="#standard-patch-actions">Patch Action</a> type specified by the <code>action</code> property. If any part of the patch fails or produces an error, reverse all modifications to the DID’s state and proceed to the next entry.</li>
</ol>
</li>
</ol>
</li>
<li>
<p><a href="#post-create-operation-processing">Post-Create operation processing</a> Once a Create operation has been successfully processed, proceed iterating forward in the DID’s observed operation set using the following processing rules depending on the operation type for each operation entry:</p>
<ul>
<li>
<p>If the entry is another Create operation, skip the entry and proceed to the next operation.</p>
</li>
<li>
<p>If the entry is an Update operation, process as follows:</p>
<ol>
<li>If the DID is flagged as <em>Non-Updateable</em>, skip the entry and proceed to the next operation.</li>
<li>Generate a hash of the entry’s <code>update_reveal_value</code> using the <a href="#hashing-process">Hashing Process</a> and compare the output to the currently retained <em>Update Commitment</em>. If the values are exactly equal, proceed, if they are not, skip the entry and proceed to the next operation.</li>
<li>Using the <code>kid</code> from the operation’s <a href="#update-signed-data-object"><em>Update Operation Signed Data Object</em></a>, locate the key currently associated with the DID that matches the <code>kid</code> value, and ensure it is designated as a key allowed to perform operations (e.g. has an<a href="#add-public-keys"><code>add-public-keys</code></a> Patch Action <code>usage</code> designation of <code>ops</code>). If no currently associated key matches the <code>kid</code> value, or the key is not designated as a key allowed to perform operations, skip the entry and proceed to the next operation.</li>
<li>Using the specified key, validate the <a href="#update-signed-data-object"><em>Update Operation Signed Data Object</em></a> signature. If the signature is valid, proceed, if the signature is invalid, skip the entry and proceed to the next operation.</li>
<li>Retrieve the <a href="#chunk-file-delta-entry"><em>Chunk File Delta Entry</em></a> from the pre-processed <a href="#chunk-file">Chunk File</a> associated with the operation and proceed to the processing instruction, or, if the <a href="#chunk-file">Chunk File</a> has not yet been retrieved and processed (i.e. node is a <a href="#light-node"><em>Light Node</em></a> implementation, file was previously unavailable, etc.), perform the following steps:
<ol>
<li>Using the <a href="#cas-protocol"><code>CAS_PROTOCOL</code></a>, fetch the <a href="#chunk-files">Chunk File</a> using the associated <em>Chunk File URI</em>. If the file is unable to be retrieved:
<ol>
<li>Internally flag the state of the DID as <em>Non-Updateable</em>.</li>
<li>Skip all further processing of the operation and proceed to the next entry.</li>
</ol>
</li>
<li>Validate the <a href="#chunk-file">Chunk File</a> using the <a href="#chunk-file-processing">Chunk File Processing</a> procedure. If the <a href="#chunk-file">Chunk File</a> is valid, proceed, if the file is invalid:
<ol>
<li>Internally flag the state of the DID as <em>Non-Updateable</em>.</li>
<li>Skip all further processing of the operation and proceed to the next entry.</li>
</ol>
</li>
</ol>
</li>
<li>Validate the <a href="#chunk-file-delta-entry"><em>Chunk File Delta Entry</em></a>. If the <a href="#chunk-file-delta-entry"><em>Chunk File Delta Entry</em></a> is valid, proceed, if the Entry is invalid, let the state of the DID reflect an <em>Empty DID State</em>.</li>
<li>Generate a hash of the decoded <a href="#chunk-file-delta-entry"><em>Chunk File Delta Entry</em></a> via the <a href="#hashing-process">Hashing Process</a> and ensure the hash equals the value of the <a href="#update-signed-data-object"><em>Update Operation Signed Data Object</em></a> <code>delta_hash</code> property. If the values are exactly equal, proceed, if they are not:
<ol>
<li>Internally flag the state of the DID as <em>Non-Updateable</em>.</li>
<li>Skip all further processing of the operation and proceed to the next entry.</li>
</ol>
</li>
<li>Retain a reference to the <code>update_commitment</code> value of the <a href="#chunk-file-delta-entry"><em>Chunk File Delta Entry</em></a> for use in processing the next Update operation.</li>
<li>Begin iterating the <code>patches</code> array in the <a href="#chunk-file-delta-entry"><em>Chunk File Delta Entry</em></a>, and for each <a href="#did-state-patch">DID State Patch</a> entry, perform the following steps:
<ol>
<li>Validate the entry in accordance any requirements imposed by the <a href="#standard-patch-actions">Patch Action</a> type indicated by the <code>action</code> value of the entry. If the entry is valid, proceed, if the entry fails validation, skip the entry and proceed to the next entry.</li>
<li>Apply the patch as directed by the <a href="#standard-patch-actions">Patch Action</a> type specified by the <code>action</code> property. If any part of the patch fails or produces an error, reverse all modifications to the DID’s state and proceed to the next entry.</li>
</ol>
</li>
</ol>
</li>
<li>
<p>If the entry is a Recovery operation, process as follows:</p>
<ol>
<li>Generate a hash of the entry’s <code>recovery_reveal_value</code> using the <a href="#hashing-process">Hashing Process</a> and compare the output to the currently retained <em>Recovery Commitment</em>. If the values are exactly equal, proceed, if they are not, skip the entry and proceed to the next operation.</li>
<li>Using the current recovery key, validate the <a href="#recovery-signed-data-object"><em>Recovery Operation Signed Data Object</em></a> signature. If the signature is valid, proceed, if the signature is invalid, skip the entry and proceed to the next operation.</li>
<li>If the DID is flagged as <em>Non-Updateable</em>, remove the flag.</li>
<li>Retain a reference to the <code>recovery_commitment</code> value of the <a href="#recovery-signed-data-object"><em>Recovery Operation Signed Data Object</em></a> for use in processing the next Recovery operation.</li>
<li>If the <a href="#recovery-signed-data-object"><em>Recovery Operation Signed Data Object</em></a> includes a <code>recovery_key</code> property with a value that is an <a href="https://tools.ietf.org/html/rfc7517">IETF RFC 7517</a> compliant JWK representation of a public key, discard the current recovery key and retain the new key for use in processing the next Recovery operation.</li>
<li>Retrieve the <a href="#chunk-file-delta-entry"><em>Chunk File Delta Entry</em></a> from the pre-processed <a href="#chunk-file">Chunk File</a> associated with the operation and proceed to the processing instruction, or, if the <a href="#chunk-file">Chunk File</a> has not yet been retrieved and processed (i.e. node is a <a href="#light-node"><em>Light Node</em></a> implementation, file was previously unavailable, etc.), perform the following steps:
<ol>
<li>Using the <a href="#cas-protocol"><code>CAS_PROTOCOL</code></a>, fetch the <a href="#chunk-files">Chunk File</a> using the associated <em>Chunk File URI</em>. If the file is unable to be retrieved:
<ol>
<li>Internally flag the state of the DID as <em>Non-Updateable</em>.</li>
<li>Skip all further processing of the operation and proceed to the next entry.</li>
</ol>
</li>
<li>Validate the <a href="#chunk-file">Chunk File</a> using the <a href="#chunk-file-processing">Chunk File Processing</a> procedure. If the <a href="#chunk-file">Chunk File</a> is valid, proceed, if the file is invalid:
<ol>
<li>Internally flag the state of the DID as <em>Non-Updateable</em>.</li>
<li>Skip all further processing of the operation and proceed to the next entry.</li>
</ol>
</li>
</ol>
</li>
<li>Validate the <a href="#chunk-file-delta-entry"><em>Chunk File Delta Entry</em></a>. If the <a href="#chunk-file-delta-entry"><em>Chunk File Delta Entry</em></a> is valid, proceed, if the Entry is invalid, let the state of the DID reflect an <em>Empty DID State</em>.</li>
<li>Generate a hash of the decoded <a href="#chunk-file-delta-entry"><em>Chunk File Delta Entry</em></a> via the <a href="#hashing-process">Hashing Process</a> and ensure the hash equals the value of the <a href="#recovery-signed-data-object"><em>Recovery Operation Signed Data Object</em></a> <code>delta_hash</code> property. If the values are exactly equal, proceed, if they are not:
<ol>
<li>Internally flag the state of the DID as <em>Non-Updateable</em>.</li>
<li>Skip all further processing of the operation and proceed to the next entry.</li>
</ol>
</li>
<li>Retain a reference to the <code>update_commitment</code> value of the <a href="#chunk-file-delta-entry"><em>Chunk File Delta Entry</em></a> for use in processing the next Update operation.</li>
<li>Begin iterating the <code>patches</code> array in the <a href="#chunk-file-delta-entry"><em>Chunk File Delta Entry</em></a>, and for each <a href="#did-state-patch">DID State Patch</a> entry, perform the following steps:
<ol>
<li>Validate the entry in accordance any requirements imposed by the <a href="#standard-patch-actions">Patch Action</a> type indicated by the <code>action</code> value of the entry. If the entry is valid, proceed, if the entry fails validation, skip the entry and proceed to the next entry.</li>
<li>Apply the patch as directed by the <a href="#standard-patch-actions">Patch Action</a> type specified by the <code>action</code> property. If any part of the patch fails or produces an error, reverse all modifications to the DID’s state and proceed to the next entry.</li>
</ol>
</li>
</ol>
</li>
<li>
<p>If the entry is a Deactivation operation, process as follows:</p>
<ol>
<li>Generate a hash of the entry’s <code>recovery_reveal_value</code> using the <a href="#hashing-process">Hashing Process</a> and compare the output to the currently retained <em>Recovery Commitment</em>. If the values are exactly equal, proceed, if they are not, skip the entry and proceed to the next operation.</li>
<li>Using the current recovery key, validate the <a href="#deactivate-signed-data-object"><em>Deactivate Operation Signed Data Object</em></a> signature. If the signature is valid, proceed, if the signature is invalid, skip the entry and proceed to the next operation.</li>
<li>If the DID is flagged as <em>Non-Updateable</em>, remove the flag.</li>
<li>The <a href="#deactivate-signed-data-object"><em>Deactivate Operation Signed Data Object</em></a> <strong><strong>must</strong></strong> include a <code>did_suffix</code> property with a value that exactly equal to the <a href="#did-suffix">DID Suffix</a> of the DID being operated on.</li>
<li>The <a href="#deactivate-signed-data-object"><em>Deactivate Operation Signed Data Object</em></a> <strong><strong>must</strong></strong> include a <code>recovery_reveal_value</code> property, and the hash of the value (generated using the <a href="#hashing-process">Hashing Process</a>) <strong><strong>must</strong></strong> be exactly equal to the currently retained <em>Recovery Commitment</em>. If the values are exactly equal, proceed, if they are not, skip the entry and proceed to the next operation.</li>
<li>Mark the DID as <em>Deactivated</em>, process no further entries.</li>
</ol>
</li>
</ul>
</li>
<li>
<p>After the DID’s operations have been evaluated in the compilation steps above, the implementation <strong><strong>MUST</strong></strong> use the DID’s compiled state to generate a valid DID Document in accordance with the <a href="https://w3c.github.io/did-core/">W3C Decentralized Identifiers</a> specification.</p>
</li>
<li>
<p>Once a valid DID Document state has been generated, proceed to the <a href="#did-resolver-output">DID Resolver Output</a> process, if you intend to output the resolved DID Document in accordance with the <a href="#https://w3c-ccg.github.io/did-resolution/">Decentralized Identifier Resolution</a> specification.</p>
</li>
</ol>
<h3 id="did-resolver-output"><a class="toc-anchor" href="#did-resolver-output">§</a> DID Resolver Output</h3>
<p>The following describes how to construct <a href="#https://w3c-ccg.github.io/did-resolution/">Decentralized Identifier Resolution</a>-compliant <em>Resolution Result</em> based on a DID resolved via the <a href="#operation-compilation">Operation Compilation</a> process described in the section above.</p>
<p>If the compiled DID <strong><strong>was not</strong></strong> determined to be <em>Unresolvable</em>, as defined in the <a href="#operation-compilation">Operation Compilation</a> process above, proceed as follows:</p>
<ol>
<li>Generate a JSON object for the <em>Resolution Result</em>, structured in accordance with the <a href="https://w3c-ccg.github.io/did-resolution/#example-14-example-did-resolution-result">Decentralized Identifier Resolution</a> specification.</li>
<li>Set the <code>didDocument</code> property of the <em>Resolution Result</em> object to the resolved DID Document generated via the <a href="#operation-compilation">Operation Compilation</a> process.</li>
<li>The <em>Resolution Result</em> object <strong><strong>MUST</strong></strong> include a <code>methodMetadata</code> property, and its value <strong><strong>MUST</strong></strong> be an object.</li>
<li>The <em>Resolution Result</em> <code>methodMetadata</code> object <strong><strong>MUST</strong></strong> include a <code>published</code> property with a boolean value. If the compiled DID state is flagged as <em>Unpublished</em> and/or <em>Unresolvable</em> (per the <a href="#operation-compilation">Operation Compilation</a> process), the <code>published</code> property <strong><strong>MUST</strong></strong> be set to <code>false</code>, otherwise, set the value to <code>true</code>.</li>
<li>If the compiled DID state is flagged as <em>Non-Updatable</em> (per the <a href="#operation-compilation">Operation Compilation</a> process), the <em>Resolution Result</em> <code>methodMetadata</code> object <strong><strong>MUST</strong></strong> include a <code>non-updatable</code> property with a boolean value, and its value <strong><strong>MUST</strong></strong> be set to <code>true</code>.</li>
</ol>
<h4 id="unresolvable-dids"><a class="toc-anchor" href="#unresolvable-dids">§</a> Unresolvable DIDs</h4>
<p>…</p>
<h2 id="method-versioning"><a class="toc-anchor" href="#method-versioning">§</a> Method Versioning</h2>
<p>It is RECOMMENDED that Sidetree based DID Methods implement the following versioning structures to support development, testing, staging and production network deployments.</p>
<p>We define a network suffix as follows for a given DID Method:</p>
<p><code>did:&lt;method&gt;:&lt;network&gt;:&lt;didUniqueSuffix&gt;</code></p>
<p>If no network suffix is provided, it is assumed that the “mainnet” or “production” network is to be used… for example, these DIDs should resolve to the same DID Document:</p>
<pre><code>did:elem:mainnet:EiD0x0JeWXQbVIpBpyeyF5FDdZN1U7enAfHnd13Qk_CYpQ
did:elem:EiD0x0JeWXQbVIpBpyeyF5FDdZN1U7enAfHnd13Qk_CYpQ
</code></pre>
<p>An ION DID on the Bitcoin Testnet3 testnet is defined as follows:</p>
<p><code>did:ion:testnet3:EiD0x0JeWXQbVIpBpyeyF5FDdZN1U7enAfHnd13Qk_CYpQ</code></p>
<p>An ELEM DID on the Ethereum Ropsten testnet is defined as follows:</p>
<p><code>did:elem:ropsten:EiD0x0JeWXQbVIpBpyeyF5FDdZN1U7enAfHnd13Qk_CYpQ</code></p>
<h2 id="context"><a class="toc-anchor" href="#context">§</a> Context</h2>
<p>Per the <a href="https://github.com/w3c/did-core">DID Core Spec</a> an <code>@context</code> MAY be used to represent a DID Document as Linked Data.</p>
<p>If an <code>@context</code> is present, any properties not defined in DID Core, <strong><strong>MUST</strong></strong> be defined in this context, or in a DID Method specific one.</p>
<p>For example:</p>
<pre class="language-json"><code class="language-json"><span class="token punctuation">{</span>
    <span class="token property">"@context"</span><span class="token operator">:</span> <span class="token punctuation">[</span>
        <span class="token string">"https://www.w3.org/ns/did/v1"</span><span class="token punctuation">,</span> 
        <span class="token string">"https://identity.foundation/sidetree/context-v1.jsonld"</span><span class="token punctuation">,</span>
        <span class="token string">"https://example.com/method/specific.jsonld"</span>
    <span class="token punctuation">]</span>
<span class="token punctuation">}</span>
</code></pre>
<h3 id="usage"><a class="toc-anchor" href="#usage">§</a> usage</h3>
<p>Deprecated. DO NOT USE.</p>
<h3 id="publickeyjwk"><a class="toc-anchor" href="#publickeyjwk">§</a> publicKeyJwk</h3>
<p>A public key in JWK format. A JSON Web Key (JWK) is a JavaScript Object Notation (JSON) data structure that represents a cryptographic key. Read <a href="https://tools.ietf.org/html/rfc7517">RFC7517</a>.</p>
<p>Example:</p>
<pre class="language-json"><code class="language-json"><span class="token punctuation">{</span>
  <span class="token property">"id"</span><span class="token operator">:</span> <span class="token string">"did:example:123#JUvpllMEYUZ2joO59UNui_XYDqxVqiFLLAJ8klWuPBw"</span><span class="token punctuation">,</span>
  <span class="token property">"type"</span><span class="token operator">:</span> <span class="token string">"EcdsaSecp256k1VerificationKey2019"</span><span class="token punctuation">,</span>
  <span class="token property">"publicKeyJwk"</span><span class="token operator">:</span> <span class="token punctuation">{</span>
    <span class="token property">"crv"</span><span class="token operator">:</span> <span class="token string">"secp256k1"</span><span class="token punctuation">,</span>
    <span class="token property">"kid"</span><span class="token operator">:</span> <span class="token string">"JUvpllMEYUZ2joO59UNui_XYDqxVqiFLLAJ8klWuPBw"</span><span class="token punctuation">,</span>
    <span class="token property">"kty"</span><span class="token operator">:</span> <span class="token string">"EC"</span><span class="token punctuation">,</span>
    <span class="token property">"x"</span><span class="token operator">:</span> <span class="token string">"dWCvM4fTdeM0KmloF57zxtBPXTOythHPMm1HCLrdd3A"</span><span class="token punctuation">,</span>
    <span class="token property">"y"</span><span class="token operator">:</span> <span class="token string">"36uMVGM7hnw-N6GnjFcihWE3SkrhMLzzLCdPMXPEXlA"</span>
  <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre>
<h3 id="publickeyhex"><a class="toc-anchor" href="#publickeyhex">§</a> publicKeyHex</h3>
<p>A hex encoded compressed public key.</p>
<p>Example:</p>
<pre class="language-json"><code class="language-json"><span class="token punctuation">{</span>
  <span class="token property">"id"</span><span class="token operator">:</span> <span class="token string">"did:example:123#JUvpllMEYUZ2joO59UNui_XYDqxVqiFLLAJ8klWuPBw"</span><span class="token punctuation">,</span>
  <span class="token property">"type"</span><span class="token operator">:</span> <span class="token string">"EcdsaSecp256k1VerificationKey2019"</span><span class="token punctuation">,</span>
  <span class="token property">"publicKeyHex"</span><span class="token operator">:</span> <span class="token string">"027560af3387d375e3342a6968179ef3c6d04f5d33b2b611cf326d4708badd7770"</span>
<span class="token punctuation">}</span>
</code></pre>

              </article>    

            </main>

            <slide-panels id="slidepanels">
              <slide-panel id="repo_issues" options="right">
                <header class="panel-header">
                  <span>
                    <svg icon><use xlink:href="#github"></use></svg>
                    <span issue-count></span>
                  </span>
                  <span class="repo-issue-toggle" panel-toggle="repo_issues">✕</span>
                </header>
                <ul id="repo_issue_list"></ul>
              </slide-panel>

              <slide-panel id="toc">
                <header class="panel-header">
                  <span>Table of Contents</span>
                  <span panel-toggle="toc">✕</span>
                </header>
                <div id="toc_list">
                  <ul class="toc">
<li><a href="#abstract">Abstract</a></li>
<li><a href="#introduction">Introduction</a></li>
<li><a href="#terminology">Terminology</a></li>
<li><a href="#protocol-versioning">Protocol Versioning</a>
<ul>
<li><a href="#version-segment-definitions">Version Segment Definitions</a></li>
<li><a href="#new-version-activation">New Version Activation</a></li>
</ul>
</li>
<li><a href="#default-parameters">Default Parameters</a></li>
<li><a href="#common-functions">Common Functions</a>
<ul>
<li><a href="#hashing-process">Hashing Process</a></li>
</ul>
</li>
<li><a href="#network-topology">Network Topology</a></li>
<li><a href="#file-structures">File Structures</a>
<ul>
<li><a href="#anchor-file">Anchor File</a></li>
<li><a href="#map-file">Map File</a></li>
<li><a href="#chunk-files">Chunk Files</a></li>
</ul>
</li>
<li><a href="#did-uri-composition">DID URI Composition</a>
<ul>
<li><a href="#long-form-did-uris">Long-Form DID URIs</a></li>
</ul>
</li>
<li><a href="#did-operations">DID Operations</a>
<ul>
<li><a href="#create">Create</a></li>
<li><a href="#update">Update</a></li>
<li><a href="#recover">Recover</a></li>
<li><a href="#deactivate">Deactivate</a></li>
</ul>
</li>
<li><a href="#did-state-patches">DID State Patches</a>
<ul>
<li><a href="#standard-patch-actions">Standard Patch Actions</a>
<ul>
<li><a href="#add-public-keys"><code>add-public-keys</code></a></li>
<li><a href="#remove-public-keys"><code>remove-public-keys</code></a></li>
<li><a href="#add-service-endpoints"><code>add-service-endpoints</code></a></li>
<li><a href="#remove-service-endpoints"><code>remove-service-endpoints</code></a></li>
<li><a href="#ietf-json-patch"><code>ietf-json-patch</code></a></li>
</ul>
</li>
</ul>
</li>
<li><a href="#transaction-operation-processing">Transaction &amp; Operation Processing</a>
<ul>
<li><a href="#transaction-anchoring">Transaction Anchoring</a></li>
<li><a href="#cas-file-propagation">CAS File Propagation</a></li>
<li><a href="#transaction-processing">Transaction Processing</a></li>
<li><a href="#anchor-file-processing">Anchor File Processing</a></li>
<li><a href="#map-file-processing">Map File Processing</a></li>
<li><a href="#chunk-file-processing">Chunk File Processing</a></li>
</ul>
</li>
<li><a href="#proof-of-fee">Proof of Fee</a>
<ul>
<li><a href="#value-locking">Value Locking</a></li>
</ul>
</li>
<li><a href="#resolution">Resolution</a>
<ul>
<li><a href="#operation-compilation">Operation Compilation</a></li>
<li><a href="#did-resolver-output">DID Resolver Output</a>
<ul>
<li><a href="#unresolvable-dids">Unresolvable DIDs</a></li>
</ul>
</li>
</ul>
</li>
<li><a href="#method-versioning">Method Versioning</a></li>
<li><a href="#context">Context</a>
<ul>
<li><a href="#usage">usage</a></li>
<li><a href="#publickeyjwk">publicKeyJwk</a></li>
<li><a href="#publickeyhex">publicKeyHex</a></li>
</ul>
</li>
</ul>

                </div>
              </slide-panel>
              
            </slide-panels>

          </body>
          <script>window.specConfig = {"title":"DIF Sidetree Protocol","logo":"https://rawcdn.githack.com/decentralized-identity/decentralized-identity.github.io/a3ca39717e440302d1fd99a796e7f00e1c42eb2d/images/logo-flat.svg","logo_link":"https://identity.foundation","source":{"host":"github","account":"decentralized-identity","repo":"sidetree"},"spec_directory":"./spec/","markdown_paths":["markdown/title.md","markdown/abstract.md","markdown/intro.md","markdown/terminology.md","markdown/versioning.md","markdown/parameters.md","markdown/common-functions.md","markdown/topology.md","markdown/file-structures.md","markdown/did-uri.md","markdown/operations.md","markdown/patches.md","markdown/processing.md","markdown/pof.md","markdown/resolution.md","markdown/method-versioning.md","markdown/context.md"],"destination":"./spec/","destinationResourcePrefix":"../spec/","rootResourcePrefix":"./spec/"}</script>
          <script src="../spec/spec-up/js/markdown-it.js"></script>
          <script src="../spec/spec-up/js/prism.js" data-manual></script>
          <script src="../spec/spec-up/js/mermaid.js"></script>
          <script src="../spec/spec-up/js/chart.js"></script>
          <script src="../spec/spec-up/js/index.js"></script>
        </html>
      